<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Beaver's Bathroom Blitz</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#2d1f0f;color:#eee;overflow:hidden;height:100vh;display:flex;justify-content:center;align-items:center;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
button,.stall,.sink,#towels,.powerup,.task-btn,.gender-opt,.pick-item,.upgrade-card{touch-action:manipulation;-webkit-touch-callout:none}
#game-container{width:100%;max-width:800px;height:100vh;max-height:900px;display:flex;flex-direction:column;position:relative}
.screen{display:none;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;position:absolute;inset:0;padding:20px;text-align:center}
.screen.active{display:flex}
#title-screen{background:linear-gradient(180deg,#3d2814 0%,#2d4a1e 60%,#1a3310 100%);gap:0;padding:15px 20px;overflow-y:auto}
.title-card{background:linear-gradient(180deg,#5a4030 0%,#3d2814 50%,#2d1f0f 100%);border:5px solid #f5a623;border-radius:20px;padding:20px 25px 25px;max-width:380px;width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.5),inset 0 2px 4px rgba(255,200,100,0.15),inset 0 -4px 8px rgba(0,0,0,0.3);position:relative}
.title-card::before{content:'';position:absolute;top:8px;left:8px;right:8px;height:2px;background:linear-gradient(90deg,transparent,rgba(255,200,100,0.3),transparent);border-radius:2px}
.title-header{text-align:center;margin-bottom:15px}
.title-logo{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px}
.title-beaver{width:56px;height:56px;position:relative;animation:title-beaver-bob 2s ease-in-out infinite}
.title-beaver .beaver-face{width:48px;height:44px}
.title-beaver .beaver-ear{width:14px;height:14px;top:0}
.title-beaver .beaver-eye{width:12px;height:12px;top:12px}
.title-beaver .beaver-eye.left{left:8px}
.title-beaver .beaver-eye.right{right:8px}
.title-beaver .beaver-pupil{width:6px;height:6px;animation:beaver-look 3s infinite}
.title-beaver .beaver-nose{width:12px;height:8px;top:22px}
.title-beaver .beaver-mouth{width:16px;height:7px;top:30px}
.title-beaver .beaver-teeth{width:12px;height:7px;top:29px}
.title-beaver .beaver-cheek{width:10px;height:7px;top:20px}
#title-screen h1{font-size:1.7em;color:#f5a623;text-shadow:3px 3px 0 #2a1a0a,-1px -1px 0 #2a1a0a,0 0 25px rgba(245,166,35,0.5);letter-spacing:2px;line-height:1.1;margin:0}
.title-tagline{color:#fdd835;font-style:italic;font-size:0.95em;margin-top:8px;text-shadow:0 2px 4px rgba(0,0,0,0.6)}
@keyframes title-beaver-bob{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-4px) rotate(2deg)}}
.gender-toggle{display:flex;gap:8px;margin:20px 0 8px}
.gender-opt{width:48px;height:48px;font-size:1.8em;border:3px solid #5d4037;border-radius:12px;background:linear-gradient(180deg,#4a3828,#2d1f0f);cursor:pointer;transition:all 0.18s cubic-bezier(0.34,1.56,0.64,1);opacity:0.6}
.gender-opt:hover{opacity:0.85;transform:scale(1.05)}
.gender-opt.selected{opacity:1;border-color:#f5a623;background:linear-gradient(180deg,#5a4030,#3d2814);box-shadow:0 0 12px rgba(245,166,35,0.4)}
.btn-play{padding:18px 60px;font-size:1.5em;letter-spacing:3px;animation:start-pulse 1.5s ease-in-out infinite;position:relative;overflow:hidden}
.btn-play::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:start-shine 2s ease-in-out infinite}
.btn-help{background:none;border:none;color:#c9a86c;font-size:0.85em;cursor:pointer;margin-top:16px;text-decoration:underline;opacity:0.85;transition:opacity 0.15s}
.btn-help:hover{opacity:1;color:#fdd835}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal.active{display:flex}
.modal-content{background:linear-gradient(180deg,#5a4030 0%,#3d2814 50%,#2d1f0f 100%);border:4px solid #f5a623;border-radius:16px;padding:20px 24px;max-width:360px;width:100%;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-title{font-size:1.2em;color:#f5a623;font-weight:bold}
.modal-close{background:none;border:none;color:#c9a86c;font-size:1.8em;cursor:pointer;line-height:1}
.modal-close:hover{color:#fff}
.tutorial-body{margin-bottom:20px}
.tutorial-item{display:flex;gap:10px;margin:12px 0;align-items:flex-start;font-size:0.9em;line-height:1.4}
.tutorial-icon{font-size:1.3em;flex-shrink:0}
.btn{padding:14px 35px;border:4px solid #a12d0a;border-radius:14px;font-size:1.15em;font-weight:bold;cursor:pointer;background:linear-gradient(180deg,#e53935 0%,#d4380d 50%,#b71c1c 100%);color:#fff;transition:all 0.15s cubic-bezier(0.34,1.56,0.64,1);box-shadow:inset 0 3px 0 rgba(255,255,255,0.25),inset 0 -3px 6px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.35);text-shadow:0 2px 3px rgba(0,0,0,0.4);letter-spacing:0.5px}
.btn:hover{transform:scale(1.06) translateY(-2px);background:linear-gradient(180deg,#ef5350 0%,#e53935 50%,#c62828 100%);box-shadow:inset 0 3px 0 rgba(255,255,255,0.3),0 6px 12px rgba(0,0,0,0.4)}
.btn:active{transform:scale(0.97);box-shadow:inset 0 3px 6px rgba(0,0,0,0.4)}
.btn:disabled{opacity:0.45;cursor:not-allowed;filter:grayscale(0.4)}
#start-btn{margin-top:12px}
@keyframes start-pulse{0%,100%{box-shadow:inset 0 3px 0 rgba(255,255,255,0.25),inset 0 -3px 6px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.35),0 0 15px rgba(229,57,53,0.4)}50%{box-shadow:inset 0 3px 0 rgba(255,255,255,0.25),inset 0 -3px 6px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.35),0 0 30px rgba(229,57,53,0.6)}}
@keyframes start-shine{0%{left:-100%}50%,100%{left:100%}}
#game-screen{align-items:stretch;justify-content:flex-start}
#hud{display:flex;justify-content:space-around;padding:12px 10px;background:repeating-linear-gradient(90deg,#4a3828 0px,#5a4838 2px,#3d2814 4px,#4a3828 6px),linear-gradient(180deg,#5a4838 0%,#3d2814 50%,#2d1f0f 100%);background-blend-mode:overlay;border-bottom:4px solid #f5a623;border-top:3px solid #2a1a0a;align-items:center;box-shadow:inset 0 2px 4px rgba(255,200,100,0.15),inset 0 -4px 8px rgba(0,0,0,0.4),0 4px 8px rgba(0,0,0,0.3)}
.hud-item{text-align:center;background:linear-gradient(180deg,rgba(0,0,0,0.2),rgba(0,0,0,0.35));padding:6px 10px;border-radius:8px;border:2px solid #5d4037;box-shadow:inset 0 1px 0 rgba(255,255,255,0.1)}
#beaver-mascot{width:48px;height:48px;position:relative;flex-shrink:0;transition:transform 0.2s}
.beaver-head{width:100%;height:100%;position:relative}
.beaver-face{width:40px;height:36px;background:linear-gradient(180deg,#c9a86c 0%,#a67c52 70%,#8b6342 100%);border-radius:50% 50% 45% 45%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border:2px solid #5d4037;box-shadow:inset 0 -4px 8px rgba(0,0,0,0.2),0 2px 4px rgba(0,0,0,0.3)}
.beaver-ear{width:12px;height:12px;background:linear-gradient(180deg,#8b6342,#6d4c2a);border-radius:50%;position:absolute;top:2px;border:2px solid #5d4037}
.beaver-ear.left{left:2px}
.beaver-ear.right{right:2px}
.beaver-eye{width:10px;height:10px;background:#fff;border-radius:50%;position:absolute;top:10px;border:1px solid #333;overflow:hidden}
.beaver-eye.left{left:6px}
.beaver-eye.right{right:6px}
.beaver-pupil{width:5px;height:5px;background:#222;border-radius:50%;position:absolute;top:2px;left:2px;transition:all 0.15s}
.beaver-nose{width:10px;height:7px;background:linear-gradient(180deg,#4a3728,#2d1f14);border-radius:50%;position:absolute;top:18px;left:50%;transform:translateX(-50%)}
.beaver-mouth{width:14px;height:6px;background:#2d1f14;border-radius:0 0 8px 8px;position:absolute;top:25px;left:50%;transform:translateX(-50%);transition:all 0.2s}
.beaver-teeth{width:10px;height:6px;background:#fff;position:absolute;top:24px;left:50%;transform:translateX(-50%);display:flex;gap:1px;border-radius:0 0 2px 2px;box-shadow:0 1px 2px rgba(0,0,0,0.3)}
.beaver-teeth::before,.beaver-teeth::after{content:'';flex:1;background:#fff;border:1px solid #ddd}
.beaver-cheek{width:8px;height:6px;background:rgba(255,150,150,0.5);border-radius:50%;position:absolute;top:16px;opacity:0;transition:opacity 0.2s}
.beaver-cheek.left{left:1px}
.beaver-cheek.right{right:1px}
.beaver-idle .beaver-pupil{animation:beaver-look 3s infinite}
.beaver-happy{animation:beaver-bounce 0.3s ease-out}
.beaver-happy .beaver-mouth{width:16px;height:8px;border-radius:0 0 10px 10px}
.beaver-happy .beaver-cheek{opacity:1}
.beaver-happy .beaver-eye{height:6px}
.beaver-excited{animation:beaver-bounce 0.15s infinite}
.beaver-excited .beaver-mouth{width:18px;height:10px;border-radius:0 0 12px 12px;background:#1a1209}
.beaver-excited .beaver-cheek{opacity:1}
.beaver-excited .beaver-eye{height:5px}
.beaver-worried .beaver-eye{height:12px}
.beaver-worried .beaver-pupil{top:4px;animation:beaver-shake 0.2s infinite}
.beaver-worried .beaver-mouth{width:10px;height:8px;border-radius:50%;background:#2d1f14}
.beaver-sad{transform:translateY(2px)}
.beaver-sad .beaver-eye{height:6px}
.beaver-sad .beaver-pupil{top:3px}
.beaver-sad .beaver-mouth{width:12px;height:4px;border-radius:8px 8px 0 0;top:27px}
@keyframes beaver-look{0%,100%{transform:translateX(0)}25%{transform:translateX(2px)}75%{transform:translateX(-2px)}}
@keyframes beaver-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
@keyframes beaver-shake{0%,100%{transform:translateX(0)}50%{transform:translateX(2px)}}
.hud-item .label{font-size:0.6em;opacity:0.9;text-transform:uppercase;color:#f5a623;letter-spacing:0.5px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
.hud-item .value{font-size:1.1em;font-weight:bold;text-shadow:0 2px 3px rgba(0,0,0,0.4)}
#dirty-count{color:#fdd835;font-size:0.9em}
.mute-btn{background:none;border:none;font-size:1.3em;cursor:pointer;padding:4px 8px;border-radius:6px;transition:transform 0.15s cubic-bezier(0.34,1.56,0.64,1),opacity 0.15s;opacity:0.75;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.4))}
.mute-btn:hover{opacity:1;transform:scale(1.15)}
.mute-btn:active{transform:scale(0.95)}
.mute-btn.muted{opacity:0.5}
#play-area{flex:1;position:relative;overflow:hidden;min-height:300px}
#play-area.shake{animation:screen-shake 0.3s}
#bathroom{position:absolute;inset:0;background:linear-gradient(180deg,#f5f0e6 0%,#ebe4d6 30%,#e0d8c8 100%);display:flex;flex-direction:column}
#bathroom::before{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:repeating-linear-gradient(0deg,transparent 0px,transparent 15px,rgba(200,190,170,0.3) 15px,rgba(200,190,170,0.3) 16px);pointer-events:none;z-index:0}
#stalls-row{display:flex;justify-content:center;gap:8px;padding:12px 10px;background:linear-gradient(180deg,#7d5a44 0%,#5d4037 50%,#4e342e 100%);border-bottom:5px solid #3e2723;box-shadow:inset 0 2px 8px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.2)}
.stall{width:62px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform 0.18s cubic-bezier(0.34,1.56,0.64,1);position:relative}
.stall:hover{transform:scale(1.08) translateY(-2px)}
.stall:active{transform:scale(0.95)}
.stall-light{width:16px;height:16px;border-radius:50%;margin-bottom:5px;border:3px solid #2a1a0a;box-shadow:inset 0 -3px 0 rgba(0,0,0,0.3),0 2px 4px rgba(0,0,0,0.4);transition:all 0.3s}
.stall-body{width:56px;height:78px;background:linear-gradient(180deg,#f5ebe0 0%,#e8dcc8 100%);border:4px solid #5d4037;border-bottom:none;border-radius:14px 14px 0 0;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;box-shadow:inset 0 0 15px rgba(93,64,55,0.15),0 4px 8px rgba(0,0,0,0.25)}
.stall-body::before{content:'';position:absolute;top:0;left:0;right:0;height:10px;background:linear-gradient(180deg,rgba(255,255,255,0.5),transparent);border-radius:10px 10px 0 0}
.stall-door{position:absolute;inset:0;background:repeating-linear-gradient(90deg,#c9a86c 0px,#d4b87a 2px,#bf9b5c 4px,#c9a86c 6px),linear-gradient(180deg,#d4b87a 0%,#a67c52 50%,#8b6342 100%);background-blend-mode:overlay;border:3px solid #5d4037;border-bottom:none;border-radius:10px 10px 0 0;transform-origin:left;transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);z-index:5;box-shadow:inset 3px 0 8px rgba(0,0,0,0.2),inset -2px 0 5px rgba(255,255,255,0.15)}
.stall-door::before{content:'';position:absolute;top:10px;left:50%;transform:translateX(-50%);width:22px;height:6px;background:linear-gradient(180deg,#4e342e,#3e2723);border-radius:3px;box-shadow:0 2px 3px rgba(0,0,0,0.3)}
.stall-door::after{content:'';position:absolute;right:6px;top:50%;transform:translateY(-50%);width:8px;height:26px;background:linear-gradient(90deg,#5d4037,#8d6e63,#5d4037);border-radius:4px;border:2px solid #3e2723;box-shadow:inset 0 -3px 4px rgba(0,0,0,0.3),2px 2px 4px rgba(0,0,0,0.4)}
.stall-door.open{transform:rotateY(-100deg)}
.stall-icon{font-size:1.5em;z-index:1;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.15))}
.stall-label{font-size:0.55em;font-weight:bold;z-index:1;margin-top:2px;text-shadow:0 1px 1px rgba(0,0,0,0.15);color:#5d4037}
.stall-bar{position:absolute;bottom:0;left:0;height:6px;background:linear-gradient(90deg,#1e88e5,#64b5f6);z-index:6;transition:width 0.08s;border-radius:0 4px 4px 0;box-shadow:0 0 10px rgba(30,136,229,0.5)}
.stall-num{font-size:0.65em;color:#5d4037;margin-top:3px;font-weight:bold;text-shadow:0 1px 0 rgba(255,255,255,0.5)}
.stall.empty .stall-light{background:radial-gradient(circle at 30% 30%,#81c784,#43a047);box-shadow:0 0 12px #43a047,inset 0 2px 4px rgba(255,255,255,0.4)}
.stall.empty .stall-body{background:linear-gradient(180deg,#e8f5e9 0%,#c8e6c9 100%)}
.stall.occupied .stall-light{background:radial-gradient(circle at 30% 30%,#ef5350,#c62828);box-shadow:0 0 12px #e53935,inset 0 2px 4px rgba(255,255,255,0.3)}
.stall.occupied .stall-body{background:linear-gradient(180deg,#ffebee 0%,#ffcdd2 100%)}
.stall.dirty .stall-light{background:radial-gradient(circle at 30% 30%,#ffee58,#f9a825);box-shadow:0 0 16px #fdd835,inset 0 2px 4px rgba(255,255,255,0.4);animation:blink 0.4s infinite alternate}
.stall.dirty .stall-body{background:linear-gradient(180deg,#e0d4b8 0%,#d4c4a0 40%,#c9b48c 100%);animation:shake 0.15s infinite;box-shadow:inset 0 0 25px rgba(120,80,30,0.35),0 4px 8px rgba(0,0,0,0.25)}
.stall.dirty .stall-body::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at 20% 30%,rgba(139,90,43,0.25) 0%,transparent 30%),radial-gradient(circle at 70% 60%,rgba(139,90,43,0.2) 0%,transparent 25%),radial-gradient(circle at 45% 80%,rgba(120,80,30,0.3) 0%,transparent 20%);pointer-events:none;border-radius:10px 10px 0 0}
/* Stink lines emanating from dirty stalls */
.stall.dirty .stink-lines{display:flex}
.stink-lines{display:none;position:absolute;top:-12px;left:50%;transform:translateX(-50%);width:44px;height:28px;pointer-events:none;z-index:10;justify-content:space-between;padding:0 4px}
.stink-line{width:4px;height:20px;background:linear-gradient(180deg,transparent 0%,rgba(139,119,42,0.7) 30%,rgba(120,100,40,0.5) 70%,transparent 100%);border-radius:50% 50% 50% 50%/60% 60% 40% 40%;animation:stink-wave 1.2s ease-in-out infinite}
.stink-line:nth-child(1){animation-delay:0s;transform-origin:bottom center}
.stink-line:nth-child(2){animation-delay:0.4s;height:24px;transform-origin:bottom center}
.stink-line:nth-child(3){animation-delay:0.8s;transform-origin:bottom center}
@keyframes stink-wave{0%{transform:translateY(0) scaleY(0.5) rotate(-8deg);opacity:0}25%{opacity:0.85}50%{transform:translateY(-12px) scaleY(1) rotate(8deg);opacity:0.7}75%{transform:translateY(-20px) scaleY(0.8) rotate(-5deg);opacity:0.4}100%{transform:translateY(-26px) scaleY(0.3) rotate(3deg);opacity:0}}
/* Fly buzzing around dirty stalls */
.stall.dirty .stall-fly{display:block}
.stall-fly{display:none;position:absolute;top:-5px;right:-8px;font-size:0.6em;z-index:12;animation:fly-buzz 1.5s ease-in-out infinite;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.4))}
@keyframes fly-buzz{0%{transform:translate(0,0) rotate(0deg)}25%{transform:translate(-8px,-4px) rotate(-15deg)}50%{transform:translate(-2px,3px) rotate(10deg)}75%{transform:translate(6px,-2px) rotate(-5deg)}100%{transform:translate(0,0) rotate(0deg)}}
.stall.cleaning .stall-light{background:radial-gradient(circle at 30% 30%,#64b5f6,#1565c0);box-shadow:0 0 14px #1e88e5,inset 0 2px 4px rgba(255,255,255,0.4)}
.stall.cleaning .stall-body{background:linear-gradient(180deg,#e3f2fd 0%,#bbdefb 100%)}
#floor-area{flex:1;position:relative;background:repeating-conic-gradient(from 0deg at 50% 50%,#c4b89a 0deg 90deg,#d8cdb5 90deg 180deg,#c4b89a 180deg 270deg,#d8cdb5 270deg 360deg);background-size:40px 40px;box-shadow:inset 0 40px 60px -20px rgba(0,0,0,0.15)}
#floor-area::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent 0px,transparent 39px,rgba(0,0,0,0.08) 39px,rgba(0,0,0,0.08) 41px),repeating-linear-gradient(0deg,transparent 0px,transparent 39px,rgba(0,0,0,0.08) 39px,rgba(0,0,0,0.08) 41px);pointer-events:none}
#floor-area::after{content:'';position:absolute;bottom:0;left:0;right:0;height:8px;background:linear-gradient(180deg,#5d4037 0%,#3e2723 100%);box-shadow:inset 0 2px 0 rgba(255,255,255,0.1),0 -2px 4px rgba(0,0,0,0.2)}
#wall-sign{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:linear-gradient(180deg,#4a8c4a 0%,#3d7a3d 50%,#2e6b2e 100%);color:#fff;padding:6px 16px;border-radius:6px;font-size:0.7em;font-weight:bold;letter-spacing:1px;border:3px solid #2a5a2a;box-shadow:0 3px 8px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.2);z-index:5;text-shadow:0 1px 2px rgba(0,0,0,0.4)}
#sinks-area{position:absolute;bottom:0;left:50%;transform:translateX(-50%);display:flex;gap:12px;padding:8px 15px;background:linear-gradient(#5a4a38,#4a3a28);border-radius:10px 10px 0 0;border:2px solid #6a5a48;border-bottom:none}
.sink{width:48px;height:42px;background:linear-gradient(#e8e8e8,#c0c0c0);border:3px solid #888;border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform 0.15s cubic-bezier(0.34,1.56,0.64,1)}
.sink:hover{transform:scale(1.1)}
.sink:active{transform:scale(0.95)}
.sink-bowl{width:30px;height:12px;background:#fff;border:2px solid #999;border-radius:0 0 10px 10px}
.sink.dirty .sink-bowl{background:#ffcc80;animation:pulse-dirty 0.5s infinite alternate}
.sink.cleaning .sink-bowl{background:#81d4fa}
.sink-label{font-size:0.45em;color:#333;font-weight:bold;margin-top:2px}
#exit-door{position:absolute;bottom:0;right:10px;width:55px;height:75px;background:linear-gradient(#5a4a3a,#3a2a1a);border:3px solid #2a1a0a;border-bottom:none;border-radius:8px 8px 0 0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:1.4em}
#exit-door::after{content:'EXIT';font-size:0.35em;color:#aaa;margin-top:2px}
#towels{position:absolute;bottom:0;left:10px;width:50px;height:60px;background:linear-gradient(#a67c52,#8b6342);border:3px solid #6d4c2a;border-bottom:none;border-radius:6px 6px 0 0;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.7em;transition:transform 0.15s cubic-bezier(0.34,1.56,0.64,1)}
#towels:hover{transform:scale(1.08)}
#towels:active{transform:scale(0.95)}
#towels.low{animation:pulse-danger 0.5s infinite alternate}
.person{position:absolute;font-size:1.8em;z-index:10;transition:opacity 0.15s,transform 0.2s}
.person-body{position:relative;width:36px;height:48px;display:flex;flex-direction:column;align-items:center}
.person-icon{position:relative;z-index:2;filter:drop-shadow(0 2px 3px rgba(0,0,0,0.4));transition:transform 0.15s}
.person-torso{position:absolute;bottom:0;width:24px;height:20px;background:linear-gradient(180deg,#5a8dd8 0%,#3d6cb8 100%);border-radius:8px 8px 4px 4px;z-index:1;border:2px solid #2d5090;box-shadow:inset 0 2px 0 rgba(255,255,255,0.2),0 2px 4px rgba(0,0,0,0.3)}
.person-legs{position:absolute;bottom:-6px;width:20px;height:10px;display:flex;gap:4px;z-index:0}
.person-leg{flex:1;background:linear-gradient(180deg,#4a4a4a,#333);border-radius:0 0 3px 3px;transition:transform 0.1s}
.person.walking{animation:none}
.person.walking .person-icon{animation:head-bob 0.25s infinite}
.person.walking .person-leg:first-child{animation:leg-walk-l 0.25s infinite}
.person.walking .person-leg:last-child{animation:leg-walk-r 0.25s infinite}
.person.entering{opacity:0;transform:scale(0.5)}
.person .patience-bar{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);width:32px;height:6px;background:#222;border-radius:4px;overflow:hidden;border:2px solid #111;box-shadow:inset 0 1px 2px rgba(0,0,0,0.5)}
.person .patience-fill{height:100%;transition:width 0.1s,background 0.3s;border-radius:2px}
.person .thought{position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:linear-gradient(180deg,#fff,#f0f0f0);padding:4px 8px;border-radius:12px;font-size:0.5em;white-space:nowrap;opacity:0;transition:opacity 0.2s,transform 0.2s;box-shadow:0 3px 8px rgba(0,0,0,0.35);border:2px solid #ddd;z-index:10}
.person .thought::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#f0f0f0}
.person.impatient .thought{opacity:1;animation:thought-bounce 0.3s ease-out}
.person.urgent .person-body{animation:urgent-shake 0.15s infinite}
.person.urgent .person-icon{filter:drop-shadow(0 0 8px rgba(229,57,53,0.7)) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.person.urgent .person-torso{background:linear-gradient(180deg,#e57373,#c62828);border-color:#b71c1c}
.person.vip .person-icon{filter:drop-shadow(0 0 10px rgba(255,215,0,0.8)) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.person.vip .person-torso{background:linear-gradient(180deg,#ffd700,#daa520);border-color:#b8860b}
.person.vip .vip-badge{position:absolute;top:-8px;right:-4px;font-size:0.5em;z-index:15}
.person.vip .patience-bar{border-color:#ffd700;box-shadow:0 0 6px rgba(255,215,0,0.5)}
.person.messy .person-icon{filter:drop-shadow(0 0 6px rgba(139,90,43,0.7)) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.person.messy .messy-badge{position:absolute;top:-6px;left:-4px;font-size:0.45em;z-index:15;animation:messy-drip 0.8s infinite alternate}
.person.messy .person-torso{background:linear-gradient(180deg,#a67c52,#8b5a2b);border-color:#6d4c2a}
.person.clean .person-icon{filter:drop-shadow(0 0 8px rgba(100,200,255,0.6)) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.person.clean .clean-badge{position:absolute;top:-6px;left:-4px;font-size:0.45em;z-index:15;animation:sparkle 0.6s infinite alternate}
.person.clean .person-torso{background:linear-gradient(180deg,#81d4fa,#4fc3f7);border-color:#0288d1}
@keyframes messy-drip{0%{transform:translateY(0)}100%{transform:translateY(2px)}}
@keyframes sparkle{0%{transform:scale(1)}100%{transform:scale(1.2);filter:brightness(1.3)}}
.person.happy .person-icon{animation:happy-bounce 0.4s ease-out;filter:drop-shadow(0 0 6px rgba(255,235,59,0.6)) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.person.disgusted .person-icon{filter:hue-rotate(80deg) saturate(1.3) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.person.disgusted .person-body{animation:disgust-recoil 0.3s ease-out}
@keyframes head-bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
@keyframes leg-walk-l{0%,100%{transform:translateY(0) rotate(-8deg)}50%{transform:translateY(3px) rotate(8deg)}}
@keyframes leg-walk-r{0%,100%{transform:translateY(3px) rotate(8deg)}50%{transform:translateY(0) rotate(-8deg)}}
@keyframes urgent-shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
@keyframes thought-bounce{0%{transform:translateX(-50%) scale(0.8)}50%{transform:translateX(-50%) scale(1.1)}100%{transform:translateX(-50%) scale(1)}}
@keyframes happy-bounce{0%{transform:scale(1)}30%{transform:scale(1.15)}60%{transform:scale(0.95)}100%{transform:scale(1)}}
@keyframes disgust-recoil{0%{transform:translateX(0)}30%{transform:translateX(-5px)}100%{transform:translateX(0)}}
#task-panel{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:repeating-linear-gradient(90deg,#3d2814 0px,#4a3424 2px,#2d1f0f 4px,#3d2814 6px),linear-gradient(180deg,#4a3424 0%,#3d2814 50%,#2d1f0f 100%);background-blend-mode:overlay;padding:14px 20px;border-radius:16px;border:4px solid #f5a623;display:none;z-index:50;box-shadow:0 6px 24px rgba(0,0,0,0.6),inset 0 2px 4px rgba(255,200,100,0.1),inset 0 -4px 8px rgba(0,0,0,0.3)}
#task-panel.show{display:block;animation:pop-in 0.15s ease-out}
#task-panel h3{font-size:0.95em;color:#f5a623;margin-bottom:8px;text-shadow:0 2px 4px rgba(0,0,0,0.5);letter-spacing:0.5px}
#task-panel .hint{font-size:0.65em;color:#c9a86c;margin-bottom:10px;text-shadow:0 1px 2px rgba(0,0,0,0.4)}
#task-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.task-btn{padding:12px 18px;background:linear-gradient(180deg,#5a4a38 0%,#4a3a28 50%,#3a2a18 100%);border:3px solid #6a5a48;border-radius:12px;color:#fff;font-size:0.9em;cursor:pointer;transition:all 0.15s cubic-bezier(0.34,1.56,0.64,1);position:relative;overflow:hidden;box-shadow:inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -2px 4px rgba(0,0,0,0.3),0 3px 6px rgba(0,0,0,0.3);text-shadow:0 1px 2px rgba(0,0,0,0.4)}
.task-btn:hover{background:linear-gradient(180deg,#6a5a48 0%,#5a4a38 50%,#4a3a28 100%);transform:scale(1.08) translateY(-2px);box-shadow:inset 0 2px 0 rgba(255,255,255,0.2),0 5px 10px rgba(0,0,0,0.4)}
.task-btn:active{transform:scale(0.95);box-shadow:inset 0 2px 4px rgba(0,0,0,0.4)}
.task-btn.done{background:linear-gradient(180deg,#4caf50 0%,#43a047 50%,#388e3c 100%);border-color:#2e7d32;opacity:0.8}
.task-btn.active{border-color:#f5a623;box-shadow:0 0 20px rgba(245,166,35,0.6),inset 0 2px 0 rgba(255,255,255,0.2);animation:glow 0.5s infinite alternate}
.task-btn .progress{position:absolute;bottom:0;left:0;height:5px;background:linear-gradient(90deg,#f5a623,#fdd835);transition:width 0.05s;border-radius:0 4px 4px 0}
#powerups{display:flex;gap:10px;padding:12px;background:repeating-linear-gradient(90deg,#3d2814 0px,#4a3424 2px,#2d1f0f 4px,#3d2814 6px),linear-gradient(180deg,#3d2814 0%,#2d1f0f 100%);background-blend-mode:overlay;border-top:4px solid #f5a623;justify-content:center;box-shadow:inset 0 4px 8px rgba(0,0,0,0.3)}
.powerup{padding:10px 14px;background:linear-gradient(180deg,#5a4a38 0%,#4a3a28 50%,#3a2a18 100%);border:3px solid #6a5a48;border-radius:12px;color:#fff;font-size:0.75em;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all 0.18s cubic-bezier(0.34,1.56,0.64,1);box-shadow:inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -2px 4px rgba(0,0,0,0.3),0 3px 6px rgba(0,0,0,0.3);text-shadow:0 1px 2px rgba(0,0,0,0.4)}
.powerup:hover{background:linear-gradient(180deg,#6a5a48 0%,#5a4a38 50%,#4a3a28 100%);transform:scale(1.08) translateY(-2px);box-shadow:inset 0 2px 0 rgba(255,255,255,0.2),0 5px 10px rgba(0,0,0,0.4)}
.powerup:active{transform:scale(0.95);box-shadow:inset 0 2px 4px rgba(0,0,0,0.4)}
.powerup.disabled{opacity:0.35;pointer-events:none;filter:grayscale(0.3)}
.powerup.active-effect{border-color:#f5a623;box-shadow:0 0 16px rgba(245,166,35,0.7),inset 0 2px 0 rgba(255,255,255,0.2);animation:glow 0.4s infinite alternate}
.powerup .count{background:linear-gradient(180deg,#e53935,#c62828);border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid #b71c1c;box-shadow:inset 0 -2px 4px rgba(0,0,0,0.3),0 2px 4px rgba(0,0,0,0.3)}
.float-msg{position:absolute;font-weight:bold;font-size:1.2em;animation:float-up 1s forwards;z-index:100;text-shadow:0 2px 4px #000;pointer-events:none}
.float-msg.good{color:#43a047}
.float-msg.bad{color:#e53935}
.float-msg.combo{color:#f5a623;font-size:1.5em}
.float-msg.save{color:#2196f3;font-size:1.3em}
#result-screen,#gameover-screen{background:linear-gradient(180deg,#3d2814 0%,#2d1f0f 100%);gap:18px}
#result-screen h2,#gameover-screen h2{font-size:1.7em;color:#f5a623;text-shadow:2px 2px 0 #2a1a0a,0 0 15px rgba(245,166,35,0.3);letter-spacing:1px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:300px}
.stat{background:linear-gradient(180deg,#5a4a38 0%,#4a3a28 50%,#3a2a18 100%);padding:14px;border-radius:12px;text-align:center;border:3px solid #6a5a48;box-shadow:inset 0 2px 0 rgba(255,255,255,0.1),inset 0 -3px 6px rgba(0,0,0,0.3),0 3px 6px rgba(0,0,0,0.3)}
.stat .num{font-size:1.5em;font-weight:bold;color:#f5a623;text-shadow:0 2px 4px rgba(0,0,0,0.4)}
.stat .lbl{font-size:0.65em;opacity:0.85;text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.grade{font-size:1.5em;padding:12px 30px;border-radius:14px;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.4);box-shadow:inset 0 2px 0 rgba(255,255,255,0.2),0 4px 10px rgba(0,0,0,0.35)}
.grade.S{background:linear-gradient(180deg,rgba(245,166,35,0.4),rgba(245,166,35,0.2));color:#fdd835;border:3px solid #f5a623;box-shadow:0 0 20px rgba(245,166,35,0.4)}
.grade.A{background:linear-gradient(180deg,rgba(67,160,71,0.4),rgba(67,160,71,0.2));color:#66bb6a;border:3px solid #43a047}
.grade.B{background:linear-gradient(180deg,rgba(30,136,229,0.4),rgba(30,136,229,0.2));color:#64b5f6;border:3px solid #1e88e5}
.grade.C{background:linear-gradient(180deg,rgba(251,140,0,0.4),rgba(251,140,0,0.2));color:#ffa726;border:3px solid #fb8c00}
.grade.F{background:linear-gradient(180deg,rgba(229,57,53,0.4),rgba(229,57,53,0.2));color:#ef5350;border:3px solid #e53935}
.pick-row{display:flex;gap:14px}
.pick-item{padding:14px 20px;background:linear-gradient(180deg,#5a4a38 0%,#4a3a28 50%,#3a2a18 100%);border:3px solid #6a5a48;border-radius:14px;cursor:pointer;text-align:center;transition:all 0.18s cubic-bezier(0.34,1.56,0.64,1);box-shadow:inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -2px 4px rgba(0,0,0,0.3),0 3px 6px rgba(0,0,0,0.3)}
.pick-item:hover{border-color:#f5a623;transform:scale(1.08) translateY(-2px);box-shadow:0 0 15px rgba(245,166,35,0.4),0 5px 10px rgba(0,0,0,0.4)}
.pick-item .icon{font-size:1.6em;filter:drop-shadow(0 2px 3px rgba(0,0,0,0.3))}
.pick-item .name{font-size:0.8em;margin-top:5px;font-weight:bold;text-shadow:0 1px 2px rgba(0,0,0,0.4)}
.pick-item .desc{font-size:0.6em;opacity:0.8;margin-top:3px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
#upgrade-screen{background:linear-gradient(180deg,#3d2814 0%,#2d1f0f 100%);gap:14px;overflow-y:auto;padding:15px 10px}
.upgrade-header{text-align:center}
.upgrade-header h2{font-size:1.5em;color:#f5a623;text-shadow:2px 2px 0 #2a1a0a;margin-bottom:5px}
.coins-display{font-size:1.3em;color:#fdd835;text-shadow:0 2px 4px rgba(0,0,0,0.4)}
.coins-display .coin-icon{font-size:1.1em}
.upgrades-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:360px;width:100%}
.upgrade-card{background:linear-gradient(180deg,#5a4a38 0%,#4a3a28 50%,#3a2a18 100%);padding:14px 10px;border-radius:14px;border:3px solid #6a5a48;text-align:center;transition:all 0.18s cubic-bezier(0.34,1.56,0.64,1);box-shadow:inset 0 2px 0 rgba(255,255,255,0.15),inset 0 -3px 6px rgba(0,0,0,0.3),0 4px 8px rgba(0,0,0,0.35);position:relative}
.upgrade-card:hover:not(.maxed){border-color:#f5a623;transform:scale(1.03) translateY(-2px);box-shadow:0 0 15px rgba(245,166,35,0.3),0 6px 12px rgba(0,0,0,0.4)}
.upgrade-card.maxed{opacity:0.7;border-color:#43a047}
.upgrade-icon{font-size:2em;filter:drop-shadow(0 3px 4px rgba(0,0,0,0.4))}
.upgrade-name{font-size:0.9em;font-weight:bold;color:#f5a623;margin-top:6px;text-shadow:0 1px 2px rgba(0,0,0,0.4)}
.upgrade-desc{font-size:0.65em;color:#c9a86c;margin-top:3px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.upgrade-level{font-size:0.75em;margin-top:8px;padding:4px 10px;background:linear-gradient(180deg,rgba(0,0,0,0.2),rgba(0,0,0,0.35));border-radius:6px;display:inline-block}
.upgrade-level .current{color:#81c784}
.upgrade-level .max{color:#888}
.upgrade-cost{margin-top:8px;padding:6px 12px;background:linear-gradient(180deg,#fdd835 0%,#f5a623 50%,#e69500 100%);color:#2d1f0f;border:2px solid #e69500;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.8em;transition:all 0.15s cubic-bezier(0.34,1.56,0.64,1);box-shadow:inset 0 2px 0 rgba(255,255,255,0.3),0 2px 4px rgba(0,0,0,0.3)}
.upgrade-cost:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(245,166,35,0.5)}
.upgrade-cost:active{transform:scale(0.95)}
.upgrade-cost.cant-afford{background:linear-gradient(180deg,#666,#555);color:#999;border-color:#444;cursor:not-allowed}
.upgrade-cost.cant-afford:hover{transform:none;box-shadow:none}
.upgrade-maxed{margin-top:8px;padding:6px 12px;background:linear-gradient(180deg,#43a047,#388e3c);color:#fff;border:2px solid #2e7d32;border-radius:8px;font-size:0.75em;font-weight:bold}
.upgrade-bonus{position:absolute;top:-8px;right:-8px;background:#e53935;color:#fff;padding:3px 8px;border-radius:10px;font-size:0.6em;font-weight:bold;border:2px solid #b71c1c}
#skip-upgrades{margin-top:10px;padding:12px 30px;background:linear-gradient(180deg,#5a4a38 0%,#4a3a28 100%);border:3px solid #6a5a48;border-radius:12px;color:#c9a86c;font-size:1em;cursor:pointer;transition:all 0.18s cubic-bezier(0.34,1.56,0.64,1);text-shadow:0 1px 2px rgba(0,0,0,0.4)}
#skip-upgrades:hover{background:linear-gradient(180deg,#6a5a48 0%,#5a4a38 100%);border-color:#8a7a68}
@keyframes blink{from{box-shadow:0 0 8px #fdd835}to{box-shadow:0 0 20px #fdd835}}
@keyframes shake{0%,100%{transform:translateX(0)}50%{transform:translateX(-3px)}}
@keyframes walk{0%,100%{transform:translateY(0) rotate(-4deg)}50%{transform:translateY(-5px) rotate(4deg)}}
/* Bouncy animations with overshoot easing */
@keyframes float-up{0%{opacity:1;transform:translateY(0) scale(1)}20%{opacity:1;transform:translateY(-15px) scale(1.25)}45%{opacity:1;transform:translateY(-30px) scale(1.15)}100%{opacity:0;transform:translateY(-60px) scale(0.7)}}
@keyframes pop-in{0%{opacity:0;transform:translateX(-50%) scale(0.5)}60%{opacity:1;transform:translateX(-50%) scale(1.08)}80%{transform:translateX(-50%) scale(0.96)}100%{opacity:1;transform:translateX(-50%) scale(1)}}
@keyframes value-bump{0%{transform:scale(1)}40%{transform:scale(1.25)}70%{transform:scale(0.92)}100%{transform:scale(1)}}
.value-bump{animation:value-bump 0.25s cubic-bezier(0.34,1.56,0.64,1)}
/* Escalating combo visual effects */
@keyframes combo-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes combo-pulse-fast{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes combo-pulse-intense{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
@keyframes combo-glow{0%,100%{text-shadow:0 0 8px rgba(245,166,35,0.6),0 2px 3px rgba(0,0,0,0.4)}50%{text-shadow:0 0 16px rgba(245,166,35,0.9),0 0 25px rgba(245,166,35,0.5),0 2px 3px rgba(0,0,0,0.4)}}
@keyframes combo-glow-intense{0%,100%{text-shadow:0 0 12px rgba(255,87,34,0.7),0 2px 3px rgba(0,0,0,0.4)}50%{text-shadow:0 0 24px rgba(255,87,34,1),0 0 40px rgba(255,87,34,0.6),0 2px 3px rgba(0,0,0,0.4)}}
@keyframes combo-glow-legendary{0%,100%{text-shadow:0 0 15px rgba(255,215,0,0.8),0 2px 3px rgba(0,0,0,0.4)}50%{text-shadow:0 0 30px rgba(255,215,0,1),0 0 50px rgba(255,215,0,0.7),0 0 70px rgba(255,165,0,0.4),0 2px 3px rgba(0,0,0,0.4)}}
@keyframes screen-edge-glow{0%,100%{box-shadow:inset 0 0 60px rgba(255,87,34,0.15)}50%{box-shadow:inset 0 0 80px rgba(255,87,34,0.25)}}
@keyframes screen-edge-legendary{0%,100%{box-shadow:inset 0 0 80px rgba(255,215,0,0.2)}50%{box-shadow:inset 0 0 120px rgba(255,215,0,0.35)}}
#combo.combo-fire{animation:combo-pulse 0.5s ease-in-out infinite,combo-glow 0.5s ease-in-out infinite}
#combo.combo-intense{animation:combo-pulse-fast 0.35s ease-in-out infinite,combo-glow-intense 0.35s ease-in-out infinite}
#combo.combo-legendary{animation:combo-pulse-intense 0.25s ease-in-out infinite,combo-glow-legendary 0.25s ease-in-out infinite}
#play-area.combo-edge-glow{animation:screen-edge-glow 0.6s ease-in-out infinite}
#play-area.combo-edge-legendary{animation:screen-edge-legendary 0.4s ease-in-out infinite}
@keyframes pulse{from{box-shadow:0 0 8px #1e88e5}to{box-shadow:0 0 16px #1e88e5}}
@keyframes glow{from{box-shadow:0 0 8px #f5a623}to{box-shadow:0 0 18px #f5a623}}
@keyframes pulse-dirty{from{background:#ffcc80}to{background:#ffb74d}}
@keyframes pulse-danger{from{background:#c62828}to{background:#e53935}}
@keyframes screen-shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1}100%{transform:translateY(-80px) rotate(360deg) scale(0);opacity:0}}
.confetti{position:absolute;font-size:1.4em;animation:confetti 0.7s forwards;pointer-events:none;z-index:200}
/* Cleaning celebration effects */
@keyframes stall-celebrate{0%{transform:scale(1)}15%{transform:scale(1.08)}35%{transform:scale(0.96)}55%{transform:scale(1.04)}75%{transform:scale(0.98)}100%{transform:scale(1)}}
@keyframes stall-success-flash{0%{box-shadow:inset 0 0 0 0 rgba(129,199,132,0)}20%{box-shadow:inset 0 0 30px 10px rgba(129,199,132,0.8)}100%{box-shadow:inset 0 0 0 0 rgba(129,199,132,0)}}
@keyframes door-swing{0%{transform:rotateY(-100deg)}30%{transform:rotateY(-20deg)}50%{transform:rotateY(-60deg)}70%{transform:rotateY(-30deg)}100%{transform:rotateY(0deg)}}
@keyframes sparkle-burst{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
.stall.celebrate{animation:stall-celebrate 0.5s ease-out}
.stall.celebrate .stall-body{animation:stall-success-flash 0.6s ease-out}
.stall.celebrate .stall-door{animation:door-swing 0.6s cubic-bezier(0.34,1.56,0.64,1) forwards}
.sparkle{position:absolute;font-size:1em;animation:sparkle-burst 0.5s ease-out forwards;pointer-events:none;z-index:201}
#combo-milestone{position:absolute;top:30%;left:50%;transform:translate(-50%,-50%) scale(0);background:linear-gradient(180deg,rgba(245,166,35,0.95),rgba(230,130,0,0.95));color:#fff;padding:12px 25px;border-radius:12px;font-size:1.5em;font-weight:bold;z-index:150;border:3px solid #f5a623;box-shadow:0 0 30px rgba(245,166,35,0.6);text-shadow:0 2px 4px rgba(0,0,0,0.4);pointer-events:none}
#combo-milestone.show{animation:milestone-pop 1.5s forwards}
#combo-milestone.legendary{background:linear-gradient(180deg,rgba(255,215,0,0.95),rgba(255,165,0,0.95));border-color:#ffd700;box-shadow:0 0 40px rgba(255,215,0,0.8)}
@keyframes milestone-pop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}15%{transform:translate(-50%,-50%) scale(1.2);opacity:1}25%{transform:translate(-50%,-50%) scale(1)}80%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-50%) scale(0.8);opacity:0}}
@keyframes combo-flash{0%{background:rgba(245,166,35,0)}50%{background:rgba(245,166,35,0.15)}100%{background:rgba(245,166,35,0)}}
.combo-flash{animation:combo-flash 0.4s}
#combo-break{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%) scale(0);color:#ff9800;font-size:1.1em;font-weight:bold;z-index:140;text-shadow:0 2px 4px rgba(0,0,0,0.5);pointer-events:none;opacity:0}
#combo-break.show{animation:combo-break-pop 0.8s forwards}
@keyframes combo-break-pop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}20%{transform:translate(-50%,-50%) scale(1.1);opacity:1}40%{transform:translate(-50%,-50%) scale(0.95)}60%{transform:translate(-50%,-50%) scale(1);opacity:0.8}100%{transform:translate(-50%,-50%) translateY(-20px);opacity:0}}
@keyframes rush-warning{0%,100%{opacity:1}50%{opacity:0.5}}
#rush-warning{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(213,0,0,0.9);color:#fff;padding:15px 30px;border-radius:10px;font-size:1.3em;font-weight:bold;display:none;z-index:100;animation:rush-warning 0.3s infinite}
#inspector-warning{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,rgba(33,150,243,0.95),rgba(25,118,210,0.95));color:#fff;padding:15px 30px;border-radius:10px;font-size:1.3em;font-weight:bold;display:none;z-index:100;animation:rush-warning 0.3s infinite;border:3px solid #1565c0;box-shadow:0 0 20px rgba(33,150,243,0.5)}
.inspector{position:absolute;z-index:25;font-size:1.6em;transition:opacity 0.3s}
.inspector-body{display:flex;flex-direction:column;align-items:center}
.inspector-icon{filter:drop-shadow(0 0 8px rgba(33,150,243,0.8)) drop-shadow(0 2px 3px rgba(0,0,0,0.4))}
.inspector-badge{position:absolute;top:-8px;right:-8px;background:#1565c0;color:#fff;font-size:0.4em;padding:2px 5px;border-radius:4px;border:2px solid #0d47a1;font-weight:bold}
.inspector-clipboard{position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);font-size:0.5em}
/* Click feedback animations */
@keyframes click-pulse{0%{transform:scale(1)}30%{transform:scale(0.92)}100%{transform:scale(1)}}
@keyframes click-flash{0%{box-shadow:inset 0 0 0 rgba(255,255,255,0)}30%{box-shadow:inset 0 0 20px rgba(255,255,255,0.5)}100%{box-shadow:inset 0 0 0 rgba(255,255,255,0)}}
@keyframes stall-click{0%{transform:scale(1)}25%{transform:scale(0.95)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes sink-ripple{0%{box-shadow:0 0 0 0 rgba(129,212,250,0.6)}100%{box-shadow:0 0 0 15px rgba(129,212,250,0)}}
.task-btn.clicked{animation:click-pulse 0.15s ease-out,click-flash 0.15s ease-out}
.stall.clicked{animation:stall-click 0.2s ease-out}
.sink.clicked{animation:sink-ripple 0.3s ease-out}
#towels.clicked{animation:click-pulse 0.2s ease-out}
.powerup.clicked{animation:click-pulse 0.15s ease-out}
/* Mobile/tablet breakpoint */
@media(max-width:600px){
#game-container{max-height:100vh}
#hud{padding:10px 6px;gap:4px}
.hud-item{padding:4px 6px}
.hud-item .label{font-size:0.5em}
.hud-item .value{font-size:0.95em}
#beaver-mascot{width:40px;height:40px}
.mute-btn{font-size:1.1em;padding:3px 6px}
#stalls-row{gap:4px;padding:8px 4px}
.stall{width:54px;min-height:88px}
.stall-body{width:48px;height:68px}
.stall-light{width:14px;height:14px}
.stall-num{font-size:0.6em}
#sinks-area{gap:8px;padding:6px 10px}
.sink{width:52px;height:46px;min-width:44px;min-height:44px}
#towels{width:52px;height:64px;min-width:44px}
#exit-door{width:48px;height:65px}
#task-panel{padding:12px 14px;bottom:70px;max-width:90%}
.task-btn{padding:14px 20px;font-size:1em;min-height:48px;min-width:60px}
#task-buttons{gap:10px}
#powerups{padding:10px 6px;gap:8px}
.powerup{padding:12px 14px;font-size:0.8em;min-height:48px}
.powerup .count{width:24px;height:24px}
.person{font-size:1.5em}
.person-body{width:32px;height:42px}
.person .patience-bar{width:28px;height:5px;bottom:-12px}
#wall-sign{font-size:0.6em;padding:4px 10px}
}
/* Phone breakpoint - extra touch-friendly */
@media(max-width:420px){
.title-card{padding:15px 16px 20px;border-width:4px;border-radius:16px;max-width:95%}
.title-beaver{width:44px;height:44px}
.title-beaver .beaver-face{width:38px;height:34px}
.title-beaver .beaver-eye{width:10px;height:10px;top:10px}
.title-beaver .beaver-eye.left{left:6px}
.title-beaver .beaver-eye.right{right:6px}
#title-screen h1{font-size:1.3em}
.title-tagline{font-size:0.85em}
.btn-play{padding:14px 45px;font-size:1.2em}
.gender-opt{width:50px;height:50px;font-size:1.6em;min-width:44px;min-height:44px}
.modal-content{padding:16px 14px;max-width:95%}
.tutorial-item{font-size:0.85em}
#hud{padding:8px 4px}
.hud-item{padding:3px 5px}
.hud-item .label{font-size:0.45em}
.hud-item .value{font-size:0.85em}
#beaver-mascot{width:36px;height:36px}
.mute-btn{font-size:1em;padding:2px 4px;min-width:32px;min-height:32px}
#stalls-row{gap:3px;padding:6px 3px}
.stall{width:48px;min-height:80px}
.stall-body{width:42px;height:60px}
.stall-light{width:12px;height:12px;border-width:2px}
.stall-num{font-size:0.55em}
.stall-door::after{width:6px;height:20px;right:4px}
#floor-area{background-size:32px 32px}
#sinks-area{gap:6px;padding:5px 8px}
.sink{width:48px;height:44px}
.sink-bowl{width:26px;height:10px}
#towels{width:48px;height:58px}
#exit-door{width:44px;height:58px;font-size:1.2em}
#task-panel{padding:10px 12px;bottom:65px}
#task-panel h3{font-size:0.85em}
#task-panel .hint{font-size:0.55em}
.task-btn{padding:12px 16px;font-size:0.95em;min-height:48px}
#powerups{padding:8px 4px;gap:6px}
.powerup{padding:10px 12px;font-size:0.75em;min-height:44px}
.powerup .count{width:22px;height:22px;font-size:0.9em}
.person{font-size:1.3em}
.person-body{width:28px;height:38px}
.person-torso{width:18px;height:14px}
.person-legs{width:14px;height:8px}
.person .patience-bar{width:24px;height:4px;bottom:-10px}
.person .thought{font-size:0.45em;padding:3px 6px}
#wall-sign{font-size:0.55em;padding:3px 8px;top:6px}
.float-msg{font-size:1em}
.stats-grid{gap:8px;max-width:280px}
.stat{padding:10px}
.stat .num{font-size:1.3em}
.upgrade-card{padding:10px 8px}
.upgrade-icon{font-size:1.6em}
.upgrade-name{font-size:0.8em}
.upgrades-grid{gap:8px;max-width:320px}
}
</style>
</head>
<body>
<div id="game-container">
  <div id="title-screen" class="screen active">
    <div class="title-card">
      <div class="title-header">
        <div class="title-logo">
          <div class="title-beaver">
            <div class="beaver-head">
              <div class="beaver-ear left"></div>
              <div class="beaver-ear right"></div>
              <div class="beaver-face">
                <div class="beaver-eye left"><div class="beaver-pupil"></div></div>
                <div class="beaver-eye right"><div class="beaver-pupil"></div></div>
                <div class="beaver-nose"></div>
                <div class="beaver-mouth"></div>
                <div class="beaver-teeth"></div>
                <div class="beaver-cheek left"></div>
                <div class="beaver-cheek right"></div>
              </div>
            </div>
          </div>
          <h1>Beaver's<br>Bathroom Blitz</h1>
        </div>
        <p class="title-tagline">"Dam Good Restrooms - Since 1982"</p>
      </div>
      <div class="gender-toggle">
        <button class="gender-opt" data-gender="male">üöπ</button>
        <button class="gender-opt selected" data-gender="female">üö∫</button>
      </div>
      <button class="btn btn-play" id="start-btn">PLAY</button>
      <button class="btn-help" id="help-btn">How to Play</button>
    </div>
  </div>

  <div id="tutorial-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">ü¶´ How to Play</span>
        <button class="modal-close" id="close-tutorial">&times;</button>
      </div>
      <div class="tutorial-body">
        <div class="tutorial-item"><span class="tutorial-icon">üöó</span><span>Road-trippers need to GO! Keep stalls spotless.</span></div>
        <div class="tutorial-item"><span class="tutorial-icon">üöΩ</span><span>Click dirty stalls, then MASH tasks to clean faster!</span></div>
        <div class="tutorial-item"><span class="tutorial-icon">üöø</span><span>Scrub those sinks - travelers notice everything!</span></div>
        <div class="tutorial-item"><span class="tutorial-icon">üìÑ</span><span>Keep towels stocked - it's the beaver way!</span></div>
        <div class="tutorial-item"><span class="tutorial-icon">‚≠ê</span><span>Protect the lodge's 5-star reputation!</span></div>
      </div>
      <button class="btn" id="tutorial-got-it">Got it!</button>
    </div>
  </div>

  <div id="game-screen" class="screen">
    <div id="hud">
      <div id="beaver-mascot" class="beaver-idle">
        <div class="beaver-head">
          <div class="beaver-ear left"></div>
          <div class="beaver-ear right"></div>
          <div class="beaver-face">
            <div class="beaver-eye left"><div class="beaver-pupil"></div></div>
            <div class="beaver-eye right"><div class="beaver-pupil"></div></div>
            <div class="beaver-nose"></div>
            <div class="beaver-mouth"></div>
            <div class="beaver-teeth"></div>
            <div class="beaver-cheek left"></div>
            <div class="beaver-cheek right"></div>
          </div>
        </div>
      </div>
      <div class="hud-item"><div class="label">Rating</div><div class="value" id="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div>
      <div class="hud-item"><div class="label">Score</div><div class="value" id="score">0</div></div>
      <div class="hud-item"><div class="label">Combo</div><div class="value" id="combo">x1</div></div>
      <div class="hud-item"><div class="label">Dirty</div><div class="value" id="dirty-count">0</div></div>
      <div class="hud-item"><div class="label">Time</div><div class="value" id="timer">1:00</div></div>
      <button id="mute-btn" class="mute-btn" aria-label="Toggle sound">üîä</button>
    </div>
    <div id="play-area">
      <div id="bathroom">
        <div id="stalls-row"></div>
        <div id="floor-area">
          <div id="wall-sign">ü¶´ KEEP IT CLEAN!</div>
          <div id="exit-door">üö™</div>
          <div id="towels"><div>üìÑ</div><div>TOWELS</div></div>
          <div id="sinks-area"></div>
        </div>
      </div>
      <div id="rush-warning">üöå TOUR BUS ARRIVING! üöå</div>
      <div id="inspector-warning">üîç HEALTH INSPECTOR! üîç</div>
      <div id="combo-milestone"></div>
      <div id="combo-break">COMBO LOST!</div>
      <div id="task-panel">
        <h3 id="task-title">Stall #1</h3>
        <div class="hint">Click rapidly to clean faster!</div>
        <div id="task-buttons"></div>
      </div>
    </div>
    <div id="powerups">
      <div class="powerup disabled" id="pow-speed">‚ö° Speed <span class="count" id="cnt-speed">0</span></div>
      <div class="powerup disabled" id="pow-slow">üê¢ Slow <span class="count" id="cnt-slow">0</span></div>
      <div class="powerup disabled" id="pow-auto">‚ú® Auto <span class="count" id="cnt-auto">0</span></div>
    </div>
  </div>

  <div id="result-screen" class="screen">
    <h2 id="result-title">Shift Complete!</h2>
    <div id="result-rating"></div>
    <div class="stats-grid" id="result-stats"></div>
    <div class="grade" id="result-grade">S</div>
    <p id="result-comment"></p>
    <div id="pick-section" style="display:none">
      <p style="font-size:0.85em;opacity:0.8;margin-bottom:10px">Choose a power-up:</p>
      <div class="pick-row" id="pick-row"></div>
    </div>
    <button class="btn" id="next-btn">Next Shift</button>
  </div>

  <div id="upgrade-screen" class="screen">
    <div class="upgrade-header">
      <h2>ü¶´ Beaver Supply Shop</h2>
      <p class="coins-display"><span class="coin-icon">ü™ô</span> <span id="coins">0</span> coins</p>
    </div>
    <div class="upgrades-grid" id="upgrades-grid"></div>
    <button id="skip-upgrades">Continue to Next Shift ‚Üí</button>
  </div>

  <div id="gameover-screen" class="screen">
    <div style="font-size:2.5em" id="go-icon">üöΩ</div>
    <h2 id="go-title">Game Over</h2>
    <p id="go-msg"></p>
    <div style="font-size:2.2em;color:#f5a623" id="go-score">0</div>
    <div class="stats-grid" id="go-stats"></div>
    <button class="btn" id="retry-btn">Try Again</button>
  </div>
</div>

<script>
const CONFIG = {
  shifts: [
    {stalls:5, sinks:2, spawnMin:3000, spawnMax:4500, occMin:2000, occMax:4000, duration:60},
    {stalls:6, sinks:2, spawnMin:2500, spawnMax:4000, occMin:1800, occMax:3500, duration:65},
    {stalls:7, sinks:3, spawnMin:2200, spawnMax:3500, occMin:1600, occMax:3200, duration:70},
    {stalls:8, sinks:3, spawnMin:1800, spawnMax:3000, occMin:1400, occMax:2800, duration:75},
    {stalls:9, sinks:3, spawnMin:1500, spawnMax:2500, occMin:1200, occMax:2500, duration:80},
    {stalls:10, sinks:4, spawnMin:1200, spawnMax:2000, occMin:1000, occMax:2200, duration:90},
  ],
  patience: 10000,
  walkSpeed: 120,
  baseTaskTime: 500,   // Base time per task
  clickBoost: 80,      // Each click reduces time by this much
  sinkCleanTime: 400,
  rushChance: 0.15,    // Chance of rush hour per shift
  inspectorChance: 0.25,  // Chance of inspector visit per shift
  inspectorPenalty: 0.5,  // Rating loss per dirty stall
  inspectorBonus: 100,    // Points for clean inspection
  // Combo milestones: [combo level, speed boost duration (ms), rating recovery, bonus points]
  comboMilestones: [
    { level: 3, speedBoost: 3000, rating: 0, points: 50, msg: 'üî• ON FIRE!' },
    { level: 5, speedBoost: 4000, rating: 0.1, points: 100, msg: '‚ö° UNSTOPPABLE!' },
    { level: 10, speedBoost: 5000, rating: 0.3, points: 250, msg: 'üåü LEGENDARY!' },
  ],
};

const UPGRADES = [
  {
    id: 'speed',
    name: 'Speed Scrub',
    icon: '‚ö°',
    desc: 'Clean tasks complete faster',
    maxLevel: 5,
    baseCost: 50,
    costScale: 1.8,  // Each level costs 1.8x more
    effect: 0.12,    // 12% faster per level
  },
  {
    id: 'patience',
    name: 'Patience Plus',
    icon: 'üïê',
    desc: 'Customers wait longer',
    maxLevel: 5,
    baseCost: 60,
    costScale: 1.7,
    effect: 0.15,    // 15% more patience per level
  },
  {
    id: 'automop',
    name: 'Auto-Mop',
    icon: 'ü§ñ',
    desc: 'Tasks auto-complete sometimes',
    maxLevel: 3,
    baseCost: 100,
    costScale: 2.0,
    effect: 0.08,    // 8% chance per level to auto-complete
  },
  {
    id: 'supplies',
    name: 'Better Supplies',
    icon: 'üì¶',
    desc: '+1 of each power-up per shift',
    maxLevel: 3,
    baseCost: 80,
    costScale: 2.2,
    effect: 1,       // +1 power-up per level
  },
];

const TASKS = [
  {id:'plunge', icon:'ü™†', label:'Plunge', chance:0.3},
  {id:'wipe', icon:'üßΩ', label:'Scrub', chance:0.75},
  {id:'mop', icon:'üßπ', label:'Mop', chance:0.45},
  {id:'tp', icon:'üßª', label:'Restock', chance:0.4},
];

const THOUGHTS = {
  impatient: ['Hurry up!', 'Come ON!', 'üò§', 'Ugh...', 'üôÑ', 'NEED TO GO!'],
  desperate: ['EMERGENCY! üö®', 'HURRY!!!', 'üò±', 'CAN\'T WAIT!', 'üíÄ'],
  happy: ['Ahh! üòå', 'Nice & clean!', '‚ú®', 'Perfect!', 'üëç'],
  disgusted: ['Gross! ü§¢', 'Ewww!', 'Nasty...', 'üòñ', 'Really?!'],
};

const CUSTOMERS_MALE = ['üë®','üë¥','üë¶','üßî','üë®‚Äçü¶∞','üë®‚Äçü¶±','üë®‚Äçü¶≥','üë±‚Äç‚ôÇÔ∏è','üßë‚Äçü¶∞','üë®‚Äçü¶≤'];
const CUSTOMERS_FEMALE = ['üë©','üëµ','üëß','üë©‚Äçü¶∞','üë©‚Äçü¶±','üë©‚Äçü¶≥','üë±‚Äç‚ôÄÔ∏è','üë©‚Äçü¶≤','üßë‚Äçü¶±','üë©‚Äçüîß'];

const CLEAN_MESSAGES = [
  'Sparkling! ‚ú®', 'Spotless!', 'Dam good!', 'Fresh!', 'Pristine!',
  'Squeaky clean!', 'Like new!', 'Beaver-approved!', 'Road-trip ready!',
  'Rest stop royalty!', 'Lodge quality!', 'Tail-slapping clean!'
];

const GAME_OVER_MESSAGES = [
  'Pack your plunger and hit the road...',
  'The lodge manager wants a word...',
  'Your beaver badge has been revoked!',
  'Time to find a new dam job...',
  'The health inspector shut you down!',
];

const WIN_MESSAGES = [
  'You\'re the pride of the pit stop!',
  'Travelers sing songs of your clean stalls!',
  'You\'ve earned your beaver badge! ü¶´',
  'The cleanest restrooms this side of Texas!',
  'Legend of the Lodge!',
];

let game = {};
let selectedGender = 'female';

// Audio
let audioCtx = null;
let isMuted = localStorage.getItem('beaverMuted') === 'true';

function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function toggleMute() {
  isMuted = !isMuted;
  localStorage.setItem('beaverMuted', isMuted);
  updateMuteButton();
}

function updateMuteButton() {
  const btn = $('mute-btn');
  if (btn) {
    btn.textContent = isMuted ? 'üîá' : 'üîä';
    btn.classList.toggle('muted', isMuted);
  }
}

function playSound(freq, duration, type = 'sine', volume = 0.25) {
  if (!audioCtx || isMuted) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    osc.type = type;
    gain.gain.setValueAtTime(volume, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  } catch(e) {}
}

function playClick() { playSound(500, 0.05, 'square', 0.15); }
function playTaskComplete() { playSound(700, 0.08); setTimeout(() => playSound(900, 0.1), 60); }

// Task-specific sounds for cartoony feel
function playPlunge() {
  // Comedic 'plop' - low burst with pop
  playSound(80 + Math.random()*20, 0.12, 'sine', 0.3);
  setTimeout(() => playSound(200 + Math.random()*50, 0.06, 'triangle', 0.2), 80);
}

function playScrub() {
  // Satisfying spray/scrub - layered high freq bursts
  const base = 1800 + Math.random()*400;
  playSound(base, 0.04, 'sawtooth', 0.08);
  setTimeout(() => playSound(base + 200, 0.03, 'sawtooth', 0.06), 20);
  setTimeout(() => playSound(base - 100, 0.05, 'sawtooth', 0.07), 40);
}

function playMop() {
  // Squeaky clean - high pitch wobble
  const freq = 800 + Math.random()*200;
  playSound(freq, 0.06, 'sine', 0.12);
  setTimeout(() => playSound(freq + 150, 0.05, 'sine', 0.1), 50);
}

function playRestock() {
  // Paper rustle - quick random crinkle bursts
  for(let i=0; i<3; i++) {
    setTimeout(() => playSound(3000 + Math.random()*2000, 0.02, 'sawtooth', 0.05), i*25);
  }
}

// Map task ID to sound function
function playTaskSound(taskId) {
  switch(taskId) {
    case 'plunge': playPlunge(); break;
    case 'wipe': playScrub(); break;
    case 'mop': playMop(); break;
    case 'tp': playRestock(); break;
    default: playClick();
  }
}
function playStallClean() {
  // Layered celebration: base arpeggio + sparkle shimmer
  playSound(523, 0.12, 'sine', 0.25);
  setTimeout(() => playSound(659, 0.12, 'sine', 0.25), 70);
  setTimeout(() => playSound(784, 0.14, 'sine', 0.25), 140);
  setTimeout(() => playSound(1047, 0.25, 'sine', 0.3), 220);
  // Add sparkle overlay (high frequency shimmer)
  setTimeout(() => playSound(2093, 0.08, 'sine', 0.12), 180);
  setTimeout(() => playSound(2349, 0.06, 'sine', 0.1), 240);
  setTimeout(() => playSound(2637, 0.05, 'sine', 0.08), 280);
}
function playBad() { playSound(200, 0.25, 'sawtooth', 0.2); }
function playUrgent() { playSound(800, 0.08, 'square', 0.1); setTimeout(() => playSound(600, 0.08, 'square', 0.1), 100); }
function playRush() { for(let i=0;i<3;i++) setTimeout(() => playSound(1000, 0.1, 'square', 0.2), i*100); }
function playInspector() { playSound(600, 0.15, 'sine', 0.2); setTimeout(() => playSound(800, 0.15, 'sine', 0.2), 150); setTimeout(() => playSound(1000, 0.2, 'sine', 0.25), 300); }
function playInspectorBad() { playSound(300, 0.3, 'sawtooth', 0.25); setTimeout(() => playSound(200, 0.4, 'sawtooth', 0.2), 200); }
function playInspectorGood() { [784, 988, 1175, 1319].forEach((f,i) => setTimeout(() => playSound(f, 0.12, 'sine', 0.2), i*80)); }
function playWin() {
  [523,659,784,1047].forEach((f,i) => setTimeout(() => playSound(f, 0.15), i*120));
}
// Combo milestone sounds - escalating intensity
function playComboMilestone(level) {
  if (level >= 10) {
    // Legendary: grand fanfare
    [523, 659, 784, 1047, 1319].forEach((f, i) => setTimeout(() => playSound(f, 0.2, 'sine', 0.3), i * 60));
  } else if (level >= 5) {
    // Unstoppable: power chord
    [392, 523, 659, 784].forEach((f, i) => setTimeout(() => playSound(f, 0.15, 'sine', 0.25), i * 70));
  } else {
    // On fire: quick hit
    [523, 659, 784].forEach((f, i) => setTimeout(() => playSound(f, 0.1, 'sine', 0.2), i * 60));
  }
}
function playComboBreak() {
  playSound(400, 0.15, 'triangle', 0.15);
  setTimeout(() => playSound(300, 0.2, 'triangle', 0.1), 100);
}

// Beaver mascot expressions
let beaverTimeout = null;
function setBeaverMood(mood, duration = 1000) {
  const beaver = document.getElementById('beaver-mascot');
  if (!beaver) return;
  beaver.className = 'beaver-' + mood;
  clearTimeout(beaverTimeout);
  if (duration > 0) {
    beaverTimeout = setTimeout(() => beaver.className = 'beaver-idle', duration);
  }
}

function $(id) { return document.getElementById(id); }
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function rnd(min, max) { return min + Math.random() * (max - min); }
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function screenShake() {
  $('play-area').classList.add('shake');
  setTimeout(() => $('play-area').classList.remove('shake'), 300);
}

function bumpValue(id) {
  const el = $(id);
  if (!el) return;
  el.classList.remove('value-bump');
  void el.offsetWidth; // Force reflow
  el.classList.add('value-bump');
}

function init() {
  game = {
    shift: 0,
    score: 0,
    rating: 5,
    combo: 0,
    maxCombo: 0,
    time: 0,
    running: false,
    stalls: [],
    sinks: [],
    people: [],
    towels: 10,
    powerups: {speed: 1, slow: 1, auto: 0},
    effects: {speed: 0, slow: 0},
    spawnTimer: 0,
    activeStall: -1,
    activeTask: -1,
    taskProgress: 0,
    stats: {cleaned: 0, served: 0, dirty: 0, abandoned: 0, saves: 0},
    personId: 0,
    gender: selectedGender,
    rushMode: false,
    rushTimer: 0,
    lastUrgentBeep: 0,
    inspector: null,          // Inspector object when active
    inspectorTimer: 0,        // Countdown until inspector appears
    inspectorWarning: 0,      // Warning countdown before inspector enters
    coins: 0,                 // Currency for upgrades
    upgrades: {speed: 0, patience: 0, automop: 0, supplies: 0},
    comboBoost: 0,            // Remaining duration of combo speed boost
    lastMilestone: 0,         // Last milestone level achieved (to avoid re-triggering)
  };
}

function getCustomers() {
  return game.gender === 'male' ? CUSTOMERS_MALE : CUSTOMERS_FEMALE;
}

function getShiftConfig() {
  return CONFIG.shifts[Math.min(game.shift, CONFIG.shifts.length - 1)];
}

function getEffectiveTaskTime() {
  // Speed upgrade reduces task time
  const speedBonus = getUpgradeEffect('speed');
  let time = CONFIG.baseTaskTime * (1 - speedBonus);
  // Combo milestone speed boost (30% faster)
  if (game.comboBoost > 0) time *= 0.7;
  return time;
}

function getEffectivePatience() {
  // Patience upgrade increases customer patience
  const patienceBonus = getUpgradeEffect('patience');
  return CONFIG.patience * (1 + patienceBonus);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  $(id).classList.add('active');
}

function spawnConfetti(x, y, count = 8) {
  const emojis = ['‚ú®','‚≠ê','üí´','üåü','üéâ'];
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = 'confetti';
    el.textContent = pick(emojis);
    el.style.left = (x + rnd(-30, 30)) + 'px';
    el.style.top = y + 'px';
    el.style.animationDelay = (i * 0.04) + 's';
    $('play-area').appendChild(el);
    setTimeout(() => el.remove(), 800);
  }
}

function spawnSparkles(x, y, count = 10) {
  const sparkles = ['‚ú®','‚≠ê','üí´','‚ú¶','‚úß'];
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = 'sparkle';
    el.textContent = pick(sparkles);
    const angle = (i / count) * Math.PI * 2;
    const dist = rnd(40, 80);
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
    el.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
    el.style.animationDelay = (i * 0.03) + 's';
    el.style.fontSize = rnd(0.8, 1.4) + 'em';
    $('play-area').appendChild(el);
    setTimeout(() => el.remove(), 600);
  }
}

function floatMessage(text, x, y, type = 'good') {
  const el = document.createElement('div');
  el.className = 'float-msg ' + type;
  el.textContent = text;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  $('play-area').appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function checkComboMilestone() {
  // Find highest milestone we've reached
  const milestones = CONFIG.comboMilestones;
  for (let i = milestones.length - 1; i >= 0; i--) {
    const m = milestones[i];
    if (game.combo >= m.level && game.lastMilestone < m.level) {
      // Reached a new milestone!
      game.lastMilestone = m.level;

      // Rewards
      if (m.speedBoost > 0) game.comboBoost = m.speedBoost;
      if (m.rating > 0) { game.rating = clamp(game.rating + m.rating, 0, 5); bumpValue('rating'); }
      if (m.points > 0) { game.score += m.points; bumpValue('score'); }

      // Visual feedback
      const banner = $('combo-milestone');
      banner.textContent = m.msg;
      banner.classList.remove('show', 'legendary');
      void banner.offsetWidth; // Force reflow
      banner.classList.add('show');
      if (m.level >= 10) banner.classList.add('legendary');
      setTimeout(() => banner.classList.remove('show', 'legendary'), 1500);

      // Screen flash
      $('play-area').classList.add('combo-flash');
      setTimeout(() => $('play-area').classList.remove('combo-flash'), 400);

      // Sound
      playComboMilestone(m.level);

      // Extra confetti for big milestones
      const confettiCount = m.level >= 10 ? 25 : (m.level >= 5 ? 18 : 12);
      spawnConfetti(400, 150, confettiCount);

      break; // Only trigger one milestone at a time
    }
  }
}

function showComboBreak(hadCombo) {
  if (hadCombo >= 3) {
    const breakMsg = $('combo-break');
    breakMsg.classList.remove('show');
    void breakMsg.offsetWidth;
    breakMsg.classList.add('show');
    setTimeout(() => breakMsg.classList.remove('show'), 800);
    playComboBreak();
  }
  game.lastMilestone = 0; // Reset milestone tracking
}

function buildStalls() {
  const row = $('stalls-row');
  row.innerHTML = '';
  const cfg = getShiftConfig();
  game.stalls = [];

  for (let i = 0; i < cfg.stalls; i++) {
    game.stalls.push({
      state: 'empty',
      timer: 0,
      tasks: [],
      customer: '',
      doorOpen: false,
      wasVip: false,
      reservedBy: null
    });

    const el = document.createElement('div');
    el.className = 'stall empty';
    el.dataset.index = i;
    el.innerHTML = `
      <div class="stink-lines"><div class="stink-line"></div><div class="stink-line"></div><div class="stink-line"></div></div>
      <div class="stall-fly">ü™∞</div>
      <div class="stall-light"></div>
      <div class="stall-body">
        <div class="stall-icon">üöΩ</div>
        <div class="stall-label"></div>
        <div class="stall-bar" style="width:0"></div>
        <div class="stall-door"></div>
      </div>
      <div class="stall-num">${i+1}</div>
    `;
    el.addEventListener('click', () => clickStall(i));
    row.appendChild(el);
  }
}

function buildSinks() {
  const container = $('sinks-area');
  container.innerHTML = '';
  const cfg = getShiftConfig();
  game.sinks = [];

  for (let i = 0; i < cfg.sinks; i++) {
    game.sinks.push({dirty: false, cleaning: false, progress: 0});

    const el = document.createElement('div');
    el.className = 'sink';
    el.dataset.index = i;
    el.innerHTML = `<div class="sink-bowl"></div><div class="sink-label">SINK</div>`;
    el.addEventListener('click', () => clickSink(i));
    container.appendChild(el);
  }
}

function updateStallDOM(i) {
  const stall = game.stalls[i];
  const el = $('stalls-row').children[i];
  if (!el) return;

  el.className = 'stall ' + stall.state;
  el.querySelector('.stall-door').classList.toggle('open', stall.doorOpen);

  const icon = el.querySelector('.stall-icon');
  const label = el.querySelector('.stall-label');
  const bar = el.querySelector('.stall-bar');

  if (stall.state === 'occupied') {
    icon.textContent = 'üöΩ';
    label.textContent = '';
  } else if (stall.state === 'dirty') {
    icon.textContent = 'üí©';
    label.textContent = 'DIRTY';
  } else if (stall.state === 'cleaning') {
    icon.textContent = 'üßπ';
    label.textContent = '';
    const total = stall.tasks.length;
    const done = stall.tasks.filter(t => t.done).length;
    const currentProg = game.activeTask >= 0 ? (game.taskProgress / getEffectiveTaskTime()) : 0;
    const progress = ((done + currentProg) / total) * 100;
    bar.style.width = Math.min(100, progress) + '%';
  } else {
    icon.textContent = 'üöΩ';
    label.textContent = '';
    bar.style.width = '0';
  }
}

function updateSinkDOM(i) {
  const sink = game.sinks[i];
  const el = $('sinks-area').children[i];
  if (!el) return;
  el.classList.toggle('dirty', sink.dirty);
  el.classList.toggle('cleaning', sink.cleaning);
}

function getDirtyCount() {
  return game.stalls.filter(s => s.state === 'dirty').length;
}

function updateHUD() {
  let stars = '';
  for (let i = 0; i < 5; i++) {
    stars += game.rating >= i + 0.75 ? '‚≠ê' : (game.rating >= i + 0.25 ? 'üåü' : '‚òÜ');
  }
  $('rating').textContent = stars;
  $('rating').style.animation = game.rating <= 1 ? 'blink 0.3s infinite' : '';

  $('score').textContent = Math.floor(game.score);

  const comboMult = 1 + game.combo * 0.5;
  const boostIcon = game.comboBoost > 0 ? '‚ö°' : '';
  const comboEl = $('combo');
  const playArea = $('play-area');
  comboEl.textContent = game.combo > 0 ? `${boostIcon}x${comboMult.toFixed(1)}` : 'x1';
  comboEl.style.color = game.combo >= 10 ? '#ffd700' : (game.combo >= 5 ? '#ff5722' : (game.combo >= 3 ? '#f5a623' : '#fff'));
  comboEl.style.fontSize = game.combo >= 10 ? '1.5em' : (game.combo >= 5 ? '1.4em' : (game.combo >= 3 ? '1.3em' : '1.1em'));
  // Escalating combo visual effects
  comboEl.classList.toggle('combo-fire', game.combo >= 3 && game.combo < 5);
  comboEl.classList.toggle('combo-intense', game.combo >= 5 && game.combo < 10);
  comboEl.classList.toggle('combo-legendary', game.combo >= 10);
  playArea.classList.toggle('combo-edge-glow', game.combo >= 5 && game.combo < 10);
  playArea.classList.toggle('combo-edge-legendary', game.combo >= 10);

  const dirtyCount = getDirtyCount();
  $('dirty-count').textContent = dirtyCount > 0 ? `‚ö†Ô∏è ${dirtyCount}` : '‚úì';
  $('dirty-count').style.color = dirtyCount > 2 ? '#e53935' : (dirtyCount > 0 ? '#fdd835' : '#43a047');

  const sec = Math.max(0, Math.ceil(game.time));
  $('timer').textContent = `${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,'0')}`;
  $('timer').style.color = sec <= 10 ? '#e53935' : (sec <= 20 ? '#fdd835' : '#43a047');
  $('timer').style.animation = sec <= 10 ? 'blink 0.5s infinite' : '';

  // Urgent beeping when time is low
  if (sec <= 10 && sec > 0 && game.running) {
    const now = Date.now();
    if (now - game.lastUrgentBeep > 1000) {
      playUrgent();
      game.lastUrgentBeep = now;
    }
  }

  $('cnt-speed').textContent = game.powerups.speed;
  $('cnt-slow').textContent = game.powerups.slow;
  $('cnt-auto').textContent = game.powerups.auto;

  $('pow-speed').classList.toggle('disabled', game.powerups.speed <= 0 && game.effects.speed <= 0);
  $('pow-slow').classList.toggle('disabled', game.powerups.slow <= 0 && game.effects.slow <= 0);
  $('pow-auto').classList.toggle('disabled', game.powerups.auto <= 0);
  $('pow-speed').classList.toggle('active-effect', game.effects.speed > 0);
  $('pow-slow').classList.toggle('active-effect', game.effects.slow > 0);

  $('towels').style.background = game.towels <= 2 ? '#c62828' : '#a67c52';
  $('towels').classList.toggle('low', game.towels <= 2);
  $('towels').children[0].textContent = game.towels > 5 ? 'üìÑüìÑüìÑ' : (game.towels > 2 ? 'üìÑüìÑ' : (game.towels > 0 ? 'üìÑ' : '‚ùå'));
}

function startShift() {
  const cfg = getShiftConfig();
  game.time = cfg.duration;
  game.spawnTimer = rnd(300, 800);
  game.people = [];
  game.stats = {cleaned: 0, served: 0, dirty: 0, abandoned: 0, saves: 0};
  game.activeStall = -1;
  game.activeTask = -1;
  game.taskProgress = 0;
  game.towels = 10;
  game.rushMode = false;
  game.rushTimer = 0;
  game.inspector = null;
  game.inspectorTimer = 0;
  game.inspectorWarning = 0;

  // Apply supplies upgrade bonus to starting powerups
  const suppliesBonus = game.upgrades.supplies;
  game.powerups = {
    speed: 1 + suppliesBonus,
    slow: 1 + suppliesBonus,
    auto: 0 + suppliesBonus
  };

  // Maybe trigger inspector visit (not on first shift)
  if (Math.random() < CONFIG.inspectorChance && game.shift > 0) {
    game.inspectorTimer = rnd(20000, 40000); // Inspector arrives after 20-40 seconds
  }

  // Maybe trigger rush hour
  if (Math.random() < CONFIG.rushChance && game.shift > 0) {
    game.rushTimer = rnd(15000, 30000); // Rush starts after 15-30 seconds
  }

  buildStalls();
  buildSinks();
  hideTaskPanel();
  updateHUD();
  showScreen('game-screen');
  $('rush-warning').style.display = 'none';
  $('inspector-warning').style.display = 'none';

  game.running = true;
  game.lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}

function gameLoop(now) {
  if (!game.running) return;

  const dt = Math.min(now - game.lastTime, 100);
  game.lastTime = now;

  update(dt);
  updateHUD();
  renderPeople();

  requestAnimationFrame(gameLoop);
}

function update(dt) {
  const cfg = getShiftConfig();

  game.time -= dt / 1000;
  if (game.time <= 0) {
    endShift();
    return;
  }

  // Rush hour logic
  if (game.rushTimer > 0) {
    game.rushTimer -= dt;
    if (game.rushTimer <= 0 && !game.rushMode) {
      game.rushMode = true;
      game.rushDuration = 8000;
      $('rush-warning').style.display = 'block';
      playRush();
      screenShake();
      setBeaverMood('worried', 0); // Stay worried during rush
    }
  }
  if (game.rushMode) {
    game.rushDuration -= dt;
    if (game.rushDuration <= 0) {
      game.rushMode = false;
      $('rush-warning').style.display = 'none';
      if (!game.inspector) setBeaverMood('idle', 0);
    }
  }

  // Health inspector logic
  if (game.inspectorTimer > 0 && !game.inspector) {
    game.inspectorTimer -= dt;
    // Show warning 3 seconds before arrival
    if (game.inspectorTimer <= 3000 && game.inspectorWarning === 0) {
      game.inspectorWarning = 3000;
      $('inspector-warning').style.display = 'block';
      playInspector();
      setBeaverMood('worried', 0);
    }
    if (game.inspectorWarning > 0) {
      game.inspectorWarning -= dt;
    }
    if (game.inspectorTimer <= 0) {
      spawnInspector();
      $('inspector-warning').style.display = 'none';
    }
  }

  // Update inspector
  if (game.inspector) {
    updateInspector(dt);
  }

  // Spawn customers
  game.spawnTimer -= dt;
  if (game.spawnTimer <= 0) {
    spawnCustomer();
    let interval = rnd(cfg.spawnMin, cfg.spawnMax);
    if (game.effects.slow > 0) interval *= 2;
    if (game.rushMode) interval *= 0.3; // Much faster during rush
    game.spawnTimer = interval;
  }

  // Update stalls
  for (let i = 0; i < game.stalls.length; i++) {
    const stall = game.stalls[i];

    if (stall.state === 'occupied') {
      stall.timer -= dt;
      if (stall.timer <= 0) {
        customerLeaves(i);
      }
    }

    if (stall.doorOpen && stall.state !== 'occupied' && stall.state !== 'dirty') {
      stall.doorOpen = false;
      updateStallDOM(i);
    }
  }

  // Update active cleaning (auto-progress, but clicking is faster!)
  if (game.activeStall >= 0 && game.activeTask >= 0) {
    const speed = game.effects.speed > 0 ? 2 : 1;
    game.taskProgress += dt * 0.3 * speed; // Slow auto-progress

    if (game.taskProgress >= getEffectiveTaskTime()) {
      completeTask();
    }
    updateStallDOM(game.activeStall);
    updateTaskPanel();
  }

  // Update sinks
  for (let i = 0; i < game.sinks.length; i++) {
    const sink = game.sinks[i];
    if (sink.cleaning) {
      sink.progress += dt;
      if (sink.progress >= CONFIG.sinkCleanTime) {
        sink.cleaning = false;
        sink.dirty = false;
        sink.progress = 0;
        game.score += 25;
        playTaskComplete();
        floatMessage('+25', 400, 350, 'good');
      }
      updateSinkDOM(i);
    }
  }

  updatePeople(dt);

  if (game.effects.speed > 0) game.effects.speed -= dt;
  if (game.effects.slow > 0) game.effects.slow -= dt;
  if (game.comboBoost > 0) game.comboBoost -= dt;

  if (game.rating <= 0) {
    gameOver();
  }
}

function spawnCustomer() {
  if (game.people.filter(p => p.phase !== 'exit').length >= 12) return;

  const floor = $('floor-area');
  const rect = floor.getBoundingClientRect();
  const exitDoor = $('exit-door').getBoundingClientRect();

  const isUrgent = Math.random() < 0.2; // 20% chance of urgent customer
  const isVip = !isUrgent && Math.random() < 0.12; // 12% chance of VIP (not if urgent)

  // Messiness: 0 = average, -1 = clean (sparkle), 1 = messy (more tasks)
  // 15% clean, 20% messy, 65% average
  const messRoll = Math.random();
  const messiness = messRoll < 0.15 ? -1 : (messRoll < 0.35 ? 1 : 0);

  // Variety of shirt colors for personality
  const shirtColors = [
    {top:'#5a8dd8',bot:'#3d6cb8',border:'#2d5090'}, // Blue
    {top:'#e57373',bot:'#c62828',border:'#b71c1c'}, // Red
    {top:'#81c784',bot:'#43a047',border:'#2e7d32'}, // Green
    {top:'#ffb74d',bot:'#fb8c00',border:'#e65100'}, // Orange
    {top:'#ba68c8',bot:'#8e24aa',border:'#6a1b9a'}, // Purple
    {top:'#4dd0e1',bot:'#00acc1',border:'#00838f'}, // Cyan
    {top:'#f06292',bot:'#e91e63',border:'#c2185b'}, // Pink
    {top:'#aed581',bot:'#7cb342',border:'#558b2f'}, // Lime
  ];

  // Determine shirt color based on type
  let shirt;
  if (isVip) {
    shirt = {top:'#ffd700',bot:'#daa520',border:'#b8860b'}; // Gold for VIP
  } else if (messiness === 1) {
    shirt = {top:'#a67c52',bot:'#8b5a2b',border:'#6d4c2a'}; // Brown for messy
  } else if (messiness === -1) {
    shirt = {top:'#81d4fa',bot:'#4fc3f7',border:'#0288d1'}; // Light blue for clean
  } else {
    shirt = pick(shirtColors);
  }

  game.people.push({
    id: ++game.personId,
    icon: pick(getCustomers()),
    x: exitDoor.left - rect.left + 15,
    y: exitDoor.top - rect.top + 20,
    phase: 'enter',
    target: -1,
    patience: isUrgent ? getEffectivePatience() * 0.6 : (isVip ? getEffectivePatience() * 0.8 : getEffectivePatience()),
    maxPatience: isUrgent ? getEffectivePatience() * 0.6 : (isVip ? getEffectivePatience() * 0.8 : getEffectivePatience()),
    urgent: isUrgent,
    vip: isVip,
    messiness: messiness, // -1 = clean, 0 = average, 1 = messy
    thought: '',
    thoughtTimer: 0,
    shirt: shirt,
  });
}

function updatePeople(dt) {
  const cfg = getShiftConfig();
  const floor = $('floor-area');
  const floorRect = floor.getBoundingClientRect();
  const baseSpeed = CONFIG.walkSpeed * (dt / 1000);

  for (let i = game.people.length - 1; i >= 0; i--) {
    const p = game.people[i];
    const speed = p.urgent ? baseSpeed * 1.4 : baseSpeed;

    // Update thought timer
    if (p.thoughtTimer > 0) p.thoughtTimer -= dt;

    // Patience - only drain when truly waiting for a stall
    // Only drain during findStall when NO empty unreserved stalls are available
    const shouldDrainPatience = p.phase === 'findStall' && !game.stalls.some(s => s.state === 'empty' && !s.reservedBy);

    if (shouldDrainPatience) {
      p.patience -= dt;

      // Show impatient thoughts
      const patienceRatio = p.patience / p.maxPatience;
      if (patienceRatio < 0.3 && p.thoughtTimer <= 0) {
        p.thought = pick(patienceRatio < 0.15 ? THOUGHTS.desperate : THOUGHTS.impatient);
        p.thoughtTimer = 2000;
      }

      if (p.patience <= 0) {
        const ratingLoss = p.vip ? 0.6 : 0.3; // VIP = 2x rating impact
        game.rating = clamp(game.rating - ratingLoss, 0, 5);
        game.stats.abandoned++;
        const hadCombo = game.combo;
        game.combo = 0;
        showComboBreak(hadCombo);
        playBad();
        screenShake();
        setBeaverMood('sad', 1500);
        const msg = p.vip ? '‚≠ê VIP LEFT! -' + ratingLoss.toFixed(1) + '‚≠ê' : 'üò§ LEFT!';
        floatMessage(msg, p.x, p.y - 20, 'bad');
        p.phase = 'exit';
        continue;
      }
    }

    if (p.phase === 'enter') {
      const tx = floorRect.width / 2 - 15 + rnd(-30, 30);
      const ty = floorRect.height / 2 - 20;
      const dx = tx - p.x, dy = ty - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 15) {
        p.phase = 'findStall';
      } else {
        p.x += (dx / dist) * speed;
        p.y += (dy / dist) * speed;
      }
    }
    else if (p.phase === 'findStall') {
      let found = -1;
      // Find empty unreserved stall
      for (let j = 0; j < game.stalls.length; j++) {
        if (game.stalls[j].state === 'empty' && !game.stalls[j].reservedBy) { found = j; break; }
      }
      // Fallback: dirty stall not being cleaned and not reserved
      if (found < 0) {
        for (let j = 0; j < game.stalls.length; j++) {
          if (game.stalls[j].state === 'dirty' && game.activeStall !== j && !game.stalls[j].reservedBy) { found = j; break; }
        }
      }
      if (found >= 0) {
        game.stalls[found].reservedBy = p; // Reserve immediately
        p.target = found;
        p.phase = 'toStall';
      }
    }
    else if (p.phase === 'toStall') {
      const stallRow = $('stalls-row');
      const stallEl = stallRow.children[p.target];
      if (!stallEl) {
        if (p.target >= 0 && game.stalls[p.target]) game.stalls[p.target].reservedBy = null;
        p.phase = 'exit';
        continue;
      }

      const stallRect = stallEl.getBoundingClientRect();
      const tx = stallRect.left - floorRect.left + stallRect.width/2 - 12;
      const ty = 8;
      const dx = tx - p.x, dy = ty - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist < 10) {
        p.phase = 'entering';
        p.enterTimer = 350;

        const stall = game.stalls[p.target];

        // Check if we're cleaning it right now (SAVE!)
        if (stall.state === 'cleaning') {
          // Close call save!
          game.stats.saves++;
          game.score += 50;
          floatMessage('SAVED! +50', p.x, p.y - 30, 'save');
          playStallClean();
          setBeaverMood('excited', 1200);

          // Complete cleaning instantly with celebration
          stall.state = 'empty';
          stall.tasks = [];
          if (game.activeStall === p.target) {
            game.activeStall = -1;
            game.activeTask = -1;
            hideTaskPanel();
          }

          // Celebrate the save!
          const stallEl = $('stalls-row').children[p.target];
          if (stallEl) {
            stallEl.classList.remove('celebrate');
            void stallEl.offsetWidth;
            stallEl.classList.add('celebrate');
            setTimeout(() => stallEl.classList.remove('celebrate'), 650);

            const rect = stallEl.getBoundingClientRect();
            const playRect = $('play-area').getBoundingClientRect();
            spawnSparkles(rect.left - playRect.left + rect.width/2, rect.top - playRect.top + 40, 12);
          }
          updateStallDOM(p.target);
        }
        else if (stall.state === 'dirty') {
          const ratingLoss = p.vip ? 0.8 : 0.4; // VIP = 2x rating impact
          game.rating = clamp(game.rating - ratingLoss, 0, 5);
          game.stats.dirty++;
          const hadCombo = game.combo;
          game.combo = 0;
          showComboBreak(hadCombo);
          playBad();
          screenShake();
          setBeaverMood('sad', 1500);
          p.thought = pick(THOUGHTS.disgusted);
          p.thoughtTimer = 2000;
          const msg = p.vip ? '‚≠ê VIP DISGUSTED! -' + ratingLoss.toFixed(1) + '‚≠ê' : '-0.4‚≠ê GROSS!';
          floatMessage(msg, p.x, p.y - 30, 'bad');
        }

        stall.doorOpen = true;
        updateStallDOM(p.target);
      } else {
        p.x += (dx / dist) * speed;
        p.y += (dy / dist) * speed;
      }
    }
    else if (p.phase === 'entering') {
      p.enterTimer -= dt;
      p.y -= speed * 0.6;

      if (p.enterTimer <= 0) {
        const stall = game.stalls[p.target];
        stall.state = 'occupied';
        stall.reservedBy = null; // Clear reservation now that customer is inside
        stall.customer = p.icon;
        stall.wasVip = p.vip; // Track if VIP used this stall
        stall.messiness = p.messiness; // Track messiness for task generation
        stall.timer = rnd(cfg.occMin, cfg.occMax);
        stall.doorOpen = false;
        stall.tasks = [];

        if (game.activeStall === p.target) {
          game.activeStall = -1;
          game.activeTask = -1;
          hideTaskPanel();
        }
        game.stats.served++;
        updateStallDOM(p.target);
        p.phase = 'inStall';
      }
    }
    else if (p.phase === 'inStall') {
      // Handled by stall timer
    }
    else if (p.phase === 'exitStall') {
      const ty = 80;
      if (p.y < ty) {
        p.y += speed;
      } else {
        p.phase = 'toSink';
      }
    }
    else if (p.phase === 'toSink') {
      const sinkIdx = game.sinks.findIndex(s => !s.dirty && !s.cleaning);
      if (sinkIdx < 0) { p.phase = 'exit'; continue; }

      const sinksArea = $('sinks-area');
      const sinkEl = sinksArea.children[sinkIdx];
      if (!sinkEl) { p.phase = 'exit'; continue; }

      const sinkRect = sinkEl.getBoundingClientRect();
      const tx = sinkRect.left - floorRect.left + sinkRect.width/2 - 12;
      const ty = sinkRect.top - floorRect.top - 30;
      const dx = tx - p.x, dy = ty - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist < 12) {
        p.phase = 'washing';
        p.washTime = 1000;
        p.sinkIdx = sinkIdx;
      } else {
        p.x += (dx / dist) * speed;
        p.y += (dy / dist) * speed;
      }
    }
    else if (p.phase === 'washing') {
      p.washTime -= dt;
      if (p.washTime <= 0) {
        if (Math.random() < 0.25) game.sinks[p.sinkIdx].dirty = true;
        if (Math.random() < 0.5 && game.towels > 0) game.towels--;
        updateSinkDOM(p.sinkIdx);
        p.thought = pick(THOUGHTS.happy);
        p.thoughtTimer = 1500;
        p.phase = 'exit';
      }
    }
    else if (p.phase === 'exit') {
      const exitDoor = $('exit-door').getBoundingClientRect();
      const tx = exitDoor.left - floorRect.left + 15;
      const ty = exitDoor.top - floorRect.top + 20;
      const dx = tx - p.x, dy = ty - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist < 20) {
        game.people.splice(i, 1);
      } else {
        p.x += (dx / dist) * speed * 1.2;
        p.y += (dy / dist) * speed * 1.2;
      }
    }
  }
}

function customerLeaves(stallIdx) {
  const stall = game.stalls[stallIdx];
  stall.state = 'dirty';
  stall.doorOpen = true;

  // Generate tasks based on customer messiness
  // Clean customers (-1): lower chance of each task, min 1 task
  // Average customers (0): normal behavior
  // Messy customers (1): higher chance of each task, likely 3-4 tasks
  const messiness = stall.messiness || 0;
  const chanceModifier = messiness === -1 ? 0.4 : (messiness === 1 ? 1.5 : 1);

  stall.tasks = TASKS.filter(t => Math.random() < (t.chance * chanceModifier)).map(t => ({...t, done: false}));

  // Ensure minimum tasks based on messiness
  if (messiness === 1 && stall.tasks.length < 3) {
    // Messy customers: guarantee at least 3 tasks
    const remaining = TASKS.filter(t => !stall.tasks.find(st => st.id === t.id));
    while (stall.tasks.length < 3 && remaining.length > 0) {
      const idx = Math.floor(Math.random() * remaining.length);
      stall.tasks.push({...remaining.splice(idx, 1)[0], done: false});
    }
  } else if (stall.tasks.length === 0) {
    // At least 1 task for everyone
    stall.tasks.push({...TASKS[1], done: false});
  }

  // Auto-mop upgrade: chance to auto-complete some tasks
  const automopChance = getUpgradeEffect('automop');
  if (automopChance > 0) {
    stall.tasks.forEach(task => {
      if (!task.done && Math.random() < automopChance) {
        task.done = true;
      }
    });
  }

  updateStallDOM(stallIdx);

  const person = game.people.find(p => p.phase === 'inStall' && p.target === stallIdx);
  if (person) {
    const stallRow = $('stalls-row');
    const stallEl = stallRow.children[stallIdx];
    const floorRect = $('floor-area').getBoundingClientRect();
    if (stallEl) {
      const stallRect = stallEl.getBoundingClientRect();
      person.x = stallRect.left - floorRect.left + stallRect.width/2 - 12;
      person.y = 8;
    }
    person.phase = 'exitStall';
  }
}

function spawnInspector() {
  const floor = $('floor-area');
  const rect = floor.getBoundingClientRect();
  const exitDoor = $('exit-door').getBoundingClientRect();

  game.inspector = {
    x: exitDoor.left - rect.left + 15,
    y: exitDoor.top - rect.top + 20,
    phase: 'enter',        // enter, inspect, counting, leave
    currentStall: -1,      // Which stall is being checked
    dirtyCount: 0,         // How many dirty stalls found
    inspectTimer: 0,       // Time spent at current stall
    countdownTimer: 0,     // Time before showing results
  };

  // Remove existing inspector element if any
  const existing = floor.querySelector('.inspector');
  if (existing) existing.remove();

  // Create inspector element
  const el = document.createElement('div');
  el.className = 'inspector';
  el.innerHTML = `
    <div class="inspector-body">
      <div class="inspector-icon">üßë‚Äç‚öïÔ∏è</div>
      <div class="inspector-badge">HEALTH</div>
      <div class="inspector-clipboard">üìã</div>
    </div>`;
  floor.appendChild(el);

  setBeaverMood('worried', 0);
}

function updateInspector(dt) {
  const inspector = game.inspector;
  if (!inspector) return;

  const floor = $('floor-area');
  const floorRect = floor.getBoundingClientRect();
  const speed = CONFIG.walkSpeed * 0.7 * (dt / 1000); // Slower than customers

  const el = floor.querySelector('.inspector');
  if (!el) return;

  if (inspector.phase === 'enter') {
    // Walk to first stall area
    const tx = floorRect.width / 2 - 60;
    const ty = 30;
    const dx = tx - inspector.x, dy = ty - inspector.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist < 10) {
      inspector.phase = 'inspect';
      inspector.currentStall = 0;
      inspector.inspectTimer = 0;
    } else {
      inspector.x += (dx / dist) * speed;
      inspector.y += (dy / dist) * speed;
    }
  }
  else if (inspector.phase === 'inspect') {
    // Move to current stall and check it
    const stallRow = $('stalls-row');
    const stallEl = stallRow.children[inspector.currentStall];

    if (!stallEl) {
      // Done with all stalls, show results
      inspector.phase = 'counting';
      inspector.countdownTimer = 1500;
      return;
    }

    const stallRect = stallEl.getBoundingClientRect();
    const tx = stallRect.left - floorRect.left + stallRect.width/2 - 20;
    const ty = 25;
    const dx = tx - inspector.x, dy = ty - inspector.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist < 10) {
      inspector.inspectTimer += dt;

      // Check stall after brief pause
      if (inspector.inspectTimer >= 600) {
        const stall = game.stalls[inspector.currentStall];
        if (stall.state === 'dirty') {
          inspector.dirtyCount++;
          floatMessage('‚ùå', inspector.x + 20, inspector.y - 10, 'bad');
          playBad();
        } else if (stall.state === 'empty') {
          floatMessage('‚úì', inspector.x + 20, inspector.y - 10, 'good');
        }
        // Move to next stall
        inspector.currentStall++;
        inspector.inspectTimer = 0;
      }
    } else {
      inspector.x += (dx / dist) * speed;
      inspector.y += (dy / dist) * speed;
    }
  }
  else if (inspector.phase === 'counting') {
    inspector.countdownTimer -= dt;
    if (inspector.countdownTimer <= 0) {
      finishInspection();
      inspector.phase = 'leave';
    }
  }
  else if (inspector.phase === 'leave') {
    // Walk to exit
    const exitDoor = $('exit-door').getBoundingClientRect();
    const tx = exitDoor.left - floorRect.left + 15;
    const ty = exitDoor.top - floorRect.top + 20;
    const dx = tx - inspector.x, dy = ty - inspector.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist < 15) {
      // Inspector gone
      game.inspector = null;
      el.remove();
      setBeaverMood('idle', 0);
      return;
    } else {
      inspector.x += (dx / dist) * speed;
      inspector.y += (dy / dist) * speed;
    }
  }

  // Update element position
  el.style.left = inspector.x + 'px';
  el.style.top = inspector.y + 'px';
}

function finishInspection() {
  const inspector = game.inspector;
  if (!inspector) return;

  const dirtyCount = inspector.dirtyCount;
  const totalStalls = game.stalls.length;

  if (dirtyCount === 0) {
    // Perfect inspection!
    game.score += CONFIG.inspectorBonus;
    game.rating = clamp(game.rating + 0.3, 0, 5);
    floatMessage('PERFECT INSPECTION! +' + CONFIG.inspectorBonus, 400, 200, 'combo');
    playInspectorGood();
    spawnConfetti(400, 200, 12);
    setBeaverMood('excited', 2000);
  } else {
    // Penalty based on dirty stalls
    const ratingLoss = dirtyCount * CONFIG.inspectorPenalty;
    game.rating = clamp(game.rating - ratingLoss, 0, 5);
    floatMessage('INSPECTION: -' + ratingLoss.toFixed(1) + '‚≠ê (' + dirtyCount + ' dirty)', 400, 200, 'bad');
    playInspectorBad();
    screenShake();
    setBeaverMood('sad', 2000);
  }
}

function renderPeople() {
  const floor = $('floor-area');

  floor.querySelectorAll('.person').forEach(el => {
    const id = parseInt(el.dataset.id);
    if (!game.people.find(p => p.id === id)) el.remove();
  });

  game.people.forEach(p => {
    if (p.phase === 'inStall') {
      const el = floor.querySelector(`.person[data-id="${p.id}"]`);
      if (el) el.remove();
      return;
    }

    let el = floor.querySelector(`.person[data-id="${p.id}"]`);
    if (!el) {
      el = document.createElement('div');
      el.className = 'person walking';
      el.dataset.id = p.id;
      // CSS art body with emoji head - custom shirt color
      const shirt = p.shirt || {top:'#5a8dd8',bot:'#3d6cb8',border:'#2d5090'};
      el.innerHTML = `
        <div class="person-body">
          <div class="person-icon">${p.icon}</div>
          <div class="person-torso" style="background:linear-gradient(180deg,${shirt.top} 0%,${shirt.bot} 100%);border-color:${shirt.border}"></div>
          <div class="person-legs"><div class="person-leg"></div><div class="person-leg"></div></div>
        </div>
        <div class="patience-bar"><div class="patience-fill"></div></div>
        <div class="thought"></div>`;
      floor.appendChild(el);
    }

    el.style.left = p.x + 'px';
    el.style.top = p.y + 'px';

    const isWalking = p.phase !== 'washing' && p.phase !== 'entering';
    el.classList.toggle('walking', isWalking);
    el.classList.toggle('entering', p.phase === 'entering');
    el.classList.toggle('urgent', p.urgent);
    el.classList.toggle('vip', p.vip);

    // Add VIP badge if needed
    if (p.vip && !el.querySelector('.vip-badge')) {
      const badge = document.createElement('div');
      badge.className = 'vip-badge';
      badge.textContent = '‚≠ê';
      el.querySelector('.person-body').appendChild(badge);
    }

    // Mood states based on thoughts
    const isHappy = p.thought && THOUGHTS.happy.includes(p.thought);
    const isDisgusted = p.thought && THOUGHTS.disgusted.includes(p.thought);
    el.classList.toggle('happy', isHappy && p.thoughtTimer > 0);
    el.classList.toggle('disgusted', isDisgusted && p.thoughtTimer > 0);

    const patienceRatio = p.patience / p.maxPatience;
    el.classList.toggle('impatient', p.thoughtTimer > 0);

    const thoughtEl = el.querySelector('.thought');
    thoughtEl.textContent = p.thoughtTimer > 0 ? p.thought : '';

    const pct = patienceRatio * 100;
    const fill = el.querySelector('.patience-fill');
    fill.style.width = pct + '%';
    fill.style.background = pct > 50 ? '#43a047' : (pct > 25 ? '#fdd835' : '#e53935');
  });
}

function clickStall(i) {
  if (!game.running) return;
  const stall = game.stalls[i];
  const stallEl = $('stalls-row').children[i];

  // Visual click feedback
  if (stallEl) {
    stallEl.classList.remove('clicked');
    void stallEl.offsetWidth;
    stallEl.classList.add('clicked');
  }

  if (stall.state === 'dirty' || stall.state === 'cleaning') {
    if (stall.state === 'dirty') {
      stall.state = 'cleaning';
      updateStallDOM(i);
    }
    game.activeStall = i;
    if (game.activeTask < 0) {
      // Auto-select first incomplete task
      const firstTask = stall.tasks.findIndex(t => !t.done);
      if (firstTask >= 0) {
        game.activeTask = firstTask;
        game.taskProgress = 0;
      }
    }
    showTaskPanel(i);
    playClick();
  }
}

function showTaskPanel(stallIdx) {
  const stall = game.stalls[stallIdx];
  const remaining = stall.tasks.filter(t => !t.done).length;
  const total = stall.tasks.length;
  $('task-title').textContent = `Stall ${stallIdx + 1} - ${total - remaining}/${total} done`;

  const btns = $('task-buttons');
  btns.innerHTML = stall.tasks.map((t, ti) => {
    const progress = game.activeTask === ti ? (game.taskProgress / getEffectiveTaskTime()) * 100 : 0;
    return `<div class="task-btn ${t.done ? 'done' : ''} ${game.activeTask === ti ? 'active' : ''}" data-idx="${ti}">
      ${t.icon} ${t.label}
      <div class="progress" style="width:${progress}%"></div>
    </div>`;
  }).join('');

  btns.querySelectorAll('.task-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const ti = parseInt(btn.dataset.idx);
      if (!stall.tasks[ti].done) {
        // Visual click feedback
        btn.classList.remove('clicked');
        void btn.offsetWidth; // Force reflow
        btn.classList.add('clicked');

        if (game.activeTask === ti) {
          // Clicking active task = boost progress!
          const boost = game.effects.speed > 0 ? CONFIG.clickBoost * 2 : CONFIG.clickBoost;
          game.taskProgress += boost;
          playTaskSound(stall.tasks[ti].id);

          if (game.taskProgress >= getEffectiveTaskTime()) {
            completeTask();
          } else {
            updateTaskPanel();
          }
        } else {
          game.activeTask = ti;
          game.taskProgress = 0;
          playTaskSound(stall.tasks[ti].id);
          showTaskPanel(stallIdx);
        }
      }
    });
  });

  $('task-panel').classList.add('show');
}

function updateTaskPanel() {
  if (game.activeStall < 0) return;
  const stall = game.stalls[game.activeStall];
  const btns = $('task-buttons').querySelectorAll('.task-btn');

  btns.forEach((btn, ti) => {
    const progress = game.activeTask === ti ? (game.taskProgress / getEffectiveTaskTime()) * 100 : 0;
    btn.querySelector('.progress').style.width = Math.min(100, progress) + '%';
    btn.classList.toggle('active', game.activeTask === ti && !stall.tasks[ti].done);
  });
}

function hideTaskPanel() {
  $('task-panel').classList.remove('show');
}

function completeTask() {
  if (game.activeStall < 0 || game.activeTask < 0) return;

  const stallIdx = game.activeStall; // Save before we reset it
  const stall = game.stalls[stallIdx];
  stall.tasks[game.activeTask].done = true;
  game.taskProgress = 0;
  playTaskComplete();

  // Check if all done
  if (stall.tasks.every(t => t.done)) {
    const wasVip = stall.wasVip;
    stall.state = 'empty';
    stall.tasks = [];
    stall.wasVip = false; // Reset for next customer
    game.combo++;
    if (game.combo > game.maxCombo) game.maxCombo = game.combo;
    checkComboMilestone();
    bumpValue('combo');

    const comboMult = 1 + game.combo * 0.5;
    const vipMult = wasVip ? 2 : 1; // VIP stalls give 2x score!
    const points = Math.floor(100 * comboMult * vipMult);
    game.score += points;
    bumpValue('score');
    game.stats.cleaned++;
    const ratingGain = wasVip ? 0.16 : 0.08; // VIP = 2x rating boost too
    game.rating = clamp(game.rating + ratingGain, 0, 5);

    const stallEl = $('stalls-row').children[stallIdx];
    if (stallEl) {
      const rect = stallEl.getBoundingClientRect();
      const playRect = $('play-area').getBoundingClientRect();
      const x = rect.left - playRect.left + rect.width/2;
      const y = rect.top - playRect.top + 20;

      // Celebration animation on the stall
      stallEl.classList.remove('celebrate');
      void stallEl.offsetWidth; // Force reflow
      stallEl.classList.add('celebrate');
      setTimeout(() => stallEl.classList.remove('celebrate'), 650);

      // Sparkle burst effect - more particles at higher combos
      const sparkleCount = game.combo >= 10 ? 24 : (game.combo >= 5 ? 20 : (game.combo >= 3 ? 14 : (wasVip ? 16 : 10)));
      spawnSparkles(x, y + 40, sparkleCount);

      let msg;
      if (game.combo >= 10) {
        msg = `üåü ${game.combo}x LEGENDARY! +${points}`;
      } else if (wasVip) {
        msg = `‚≠ê VIP! +${points}`;
      } else if (game.combo >= 5) {
        msg = `‚ö° ${game.combo}x COMBO! +${points}`;
      } else if (game.combo >= 3) {
        msg = `üî• ${game.combo}x COMBO! +${points}`;
      } else {
        msg = `+${points} ${pick(CLEAN_MESSAGES)}`;
      }
      floatMessage(msg, x, y, (wasVip || game.combo >= 3) ? 'combo' : 'good');
      const confettiCount = game.combo >= 10 ? 22 : (game.combo >= 5 ? 18 : (game.combo >= 3 ? 12 : (wasVip ? 14 : 6)));
      spawnConfetti(x, y + 30, confettiCount);
    }

    playStallClean();
    // Beaver always gets excited for a clean stall!
    if (wasVip || game.combo >= 3) {
      screenShake();
      setBeaverMood('excited', 1500);
    } else {
      setBeaverMood('excited', 800);
    }

    game.activeStall = -1;
    game.activeTask = -1;
    hideTaskPanel();
  } else {
    // Move to next task
    const nextTask = stall.tasks.findIndex(t => !t.done);
    game.activeTask = nextTask;
    showTaskPanel(game.activeStall);
  }

  updateStallDOM(stallIdx);
}

function clickSink(i) {
  if (!game.running) return;
  const sink = game.sinks[i];
  const sinkEl = $('sinks-area').children[i];

  // Visual click feedback
  if (sinkEl) {
    sinkEl.classList.remove('clicked');
    void sinkEl.offsetWidth;
    sinkEl.classList.add('clicked');
  }

  if (sink.dirty && !sink.cleaning) {
    sink.cleaning = true;
    sink.progress = 0;
    playClick();
  }
}

$('towels').addEventListener('click', () => {
  if (!game.running) return;
  const towelEl = $('towels');

  // Visual click feedback
  towelEl.classList.remove('clicked');
  void towelEl.offsetWidth;
  towelEl.classList.add('clicked');

  if (game.towels < 10) {
    game.towels = 10;
    game.score += 20;
    floatMessage('+20 Restocked!', 60, 300, 'good');
    playTaskComplete();
  }
});

$('pow-speed').addEventListener('click', () => {
  const el = $('pow-speed');
  el.classList.remove('clicked'); void el.offsetWidth; el.classList.add('clicked');
  if (game.powerups.speed > 0 && game.effects.speed <= 0) {
    game.powerups.speed--;
    game.effects.speed = 12000;
    playClick();
    floatMessage('‚ö° SPEED BOOST!', 400, 200, 'combo');
  }
});

$('pow-slow').addEventListener('click', () => {
  const el = $('pow-slow');
  el.classList.remove('clicked'); void el.offsetWidth; el.classList.add('clicked');
  if (game.powerups.slow > 0 && game.effects.slow <= 0) {
    game.powerups.slow--;
    game.effects.slow = 12000;
    playClick();
    floatMessage('üê¢ SLOW MODE!', 400, 200, 'combo');
  }
});

$('pow-auto').addEventListener('click', () => {
  const el = $('pow-auto');
  el.classList.remove('clicked'); void el.offsetWidth; el.classList.add('clicked');
  if (game.powerups.auto > 0) {
    const dirty = game.stalls.findIndex(s => s.state === 'dirty');
    if (dirty >= 0) {
      game.powerups.auto--;
      game.stalls[dirty].state = 'empty';
      game.stalls[dirty].tasks = [];
      game.score += 75;
      game.stats.cleaned++;
      updateStallDOM(dirty);

      const stallEl = $('stalls-row').children[dirty];
      if (stallEl) {
        // Celebration animation
        stallEl.classList.remove('celebrate');
        void stallEl.offsetWidth;
        stallEl.classList.add('celebrate');
        setTimeout(() => stallEl.classList.remove('celebrate'), 650);

        const rect = stallEl.getBoundingClientRect();
        const playRect = $('play-area').getBoundingClientRect();
        const x = rect.left - playRect.left + rect.width/2;
        const y = rect.top - playRect.top;
        spawnSparkles(x, y + 40, 12);
        spawnConfetti(x, y + 30, 10);
        floatMessage('‚ú® AUTO CLEAN!', rect.left - playRect.left, y, 'combo');
      }
      playStallClean();
      setBeaverMood('excited', 1000);
    }
  }
});

// Upgrade system functions
function getUpgradeCost(upgrade, level) {
  return Math.floor(upgrade.baseCost * Math.pow(upgrade.costScale, level));
}

function getUpgradeEffect(upgradeId) {
  const upgrade = UPGRADES.find(u => u.id === upgradeId);
  if (!upgrade) return 0;
  return upgrade.effect * game.upgrades[upgradeId];
}

function calculateCoins(score, grade) {
  // Base coins from score
  let coins = Math.floor(score / 10);
  // Grade bonus multiplier
  const gradeBonus = {S: 2, A: 1.5, B: 1.2, C: 1, F: 0.5};
  coins = Math.floor(coins * (gradeBonus[grade] || 1));
  return coins;
}

function renderUpgradeShop() {
  const grid = $('upgrades-grid');
  grid.innerHTML = '';
  $('coins').textContent = game.coins;

  UPGRADES.forEach(upgrade => {
    const level = game.upgrades[upgrade.id];
    const maxed = level >= upgrade.maxLevel;
    const cost = getUpgradeCost(upgrade, level);
    const canAfford = game.coins >= cost;

    const card = document.createElement('div');
    card.className = 'upgrade-card' + (maxed ? ' maxed' : '');
    card.innerHTML = `
      <div class="upgrade-icon">${upgrade.icon}</div>
      <div class="upgrade-name">${upgrade.name}</div>
      <div class="upgrade-desc">${upgrade.desc}</div>
      <div class="upgrade-level">
        <span class="current">Lv.${level}</span>/<span class="max">${upgrade.maxLevel}</span>
      </div>
      ${maxed
        ? '<div class="upgrade-maxed">‚úì MAXED</div>'
        : `<button class="upgrade-cost ${canAfford ? '' : 'cant-afford'}" data-id="${upgrade.id}">
            ü™ô ${cost}
          </button>`
      }
    `;

    if (!maxed) {
      const btn = card.querySelector('.upgrade-cost');
      btn.addEventListener('click', () => purchaseUpgrade(upgrade.id));
    }

    grid.appendChild(card);
  });
}

function purchaseUpgrade(upgradeId) {
  const upgrade = UPGRADES.find(u => u.id === upgradeId);
  if (!upgrade) return;

  const level = game.upgrades[upgradeId];
  if (level >= upgrade.maxLevel) return;

  const cost = getUpgradeCost(upgrade, level);
  if (game.coins < cost) return;

  game.coins -= cost;
  game.upgrades[upgradeId]++;
  playTaskComplete();
  renderUpgradeShop();
}

function showUpgradeScreen() {
  renderUpgradeShop();
  showScreen('upgrade-screen');
}

function endShift() {
  game.running = false;
  playWin();

  // Clean up inspector if still present
  game.inspector = null;
  const inspectorEl = $('floor-area').querySelector('.inspector');
  if (inspectorEl) inspectorEl.remove();
  $('inspector-warning').style.display = 'none';

  $('result-title').textContent = `Shift ${game.shift + 1} Complete!`;

  let stars = '';
  for (let i = 0; i < 5; i++) stars += game.rating >= i + 0.75 ? '‚≠ê' : (game.rating >= i + 0.25 ? 'üåü' : '‚òÜ');
  $('result-rating').innerHTML = `<span style="font-size:1.6em">${stars}</span>`;

  $('result-stats').innerHTML = `
    <div class="stat"><div class="num">${game.stats.cleaned}</div><div class="lbl">Stalls Cleaned</div></div>
    <div class="stat"><div class="num">${game.stats.served}</div><div class="lbl">Customers</div></div>
    <div class="stat"><div class="num">${game.maxCombo}x</div><div class="lbl">Best Combo</div></div>
    <div class="stat"><div class="num">${Math.floor(game.score)}</div><div class="lbl">Score</div></div>
  `;

  const ratio = game.stats.dirty / Math.max(1, game.stats.served);
  let grade, comment;
  if (ratio === 0 && game.stats.abandoned === 0) { grade = 'S'; comment = 'PERFECT! You\'re a true Beaver! ü¶´'; }
  else if (ratio <= 0.1) { grade = 'A'; comment = 'Dam good work, partner!'; }
  else if (ratio <= 0.2) { grade = 'B'; comment = 'The lodge approves! Keep building!'; }
  else if (ratio <= 0.35) { grade = 'C'; comment = 'Busy beaver needs more hustle...'; }
  else { grade = 'F'; comment = 'This dam is leaking... badly.'; }

  $('result-grade').textContent = grade;
  $('result-grade').className = 'grade ' + grade;
  $('result-comment').textContent = comment;

  // Award coins based on performance
  const coinsEarned = calculateCoins(game.score, grade);
  game.coins += coinsEarned;

  // Show coins earned in pick-section
  if (game.shift + 1 < CONFIG.shifts.length) {
    $('pick-section').style.display = 'block';
    $('pick-row').innerHTML = `
      <div class="stat" style="grid-column: span 2; margin: 0 auto;">
        <div class="num" style="color:#fdd835">ü™ô +${coinsEarned}</div>
        <div class="lbl">Coins Earned</div>
      </div>
    `;
    $('next-btn').textContent = 'Visit Supply Shop ‚Üí';
  } else {
    $('pick-section').style.display = 'block';
    $('pick-row').innerHTML = `
      <div class="stat" style="grid-column: span 2; margin: 0 auto;">
        <div class="num" style="color:#fdd835">ü™ô +${coinsEarned}</div>
        <div class="lbl">Coins Earned</div>
      </div>
    `;
    $('next-btn').textContent = 'Final Results';
  }

  showScreen('result-screen');
}

function gameOver() {
  game.running = false;

  // Clean up inspector if still present
  game.inspector = null;
  const inspectorEl = $('floor-area').querySelector('.inspector');
  if (inspectorEl) inspectorEl.remove();
  $('inspector-warning').style.display = 'none';

  const won = game.shift >= CONFIG.shifts.length - 1;
  $('go-icon').textContent = won ? 'üèÜ' : 'üíÄ';
  $('go-title').textContent = won ? 'RESTROOM ROYALTY!' : 'FIRED!';
  $('go-msg').textContent = won ? pick(WIN_MESSAGES) : pick(GAME_OVER_MESSAGES);
  $('go-score').textContent = Math.floor(game.score);

  $('go-stats').innerHTML = `
    <div class="stat"><div class="num">${game.stats.cleaned}</div><div class="lbl">Cleaned</div></div>
    <div class="stat"><div class="num">${game.stats.served}</div><div class="lbl">Served</div></div>
    <div class="stat"><div class="num">${game.maxCombo}x</div><div class="lbl">Best Combo</div></div>
    <div class="stat"><div class="num">${game.stats.saves}</div><div class="lbl">Close Calls</div></div>
  `;

  if (won) playWin();
  else playBad();
  showScreen('gameover-screen');
}

// Gender toggle
document.querySelectorAll('.gender-opt').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.gender-opt').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedGender = btn.dataset.gender;
    playClick();
  });
});

// Tutorial modal
$('help-btn').addEventListener('click', () => {
  $('tutorial-modal').classList.add('active');
});
$('close-tutorial').addEventListener('click', () => {
  $('tutorial-modal').classList.remove('active');
});
$('tutorial-got-it').addEventListener('click', () => {
  $('tutorial-modal').classList.remove('active');
});
$('tutorial-modal').addEventListener('click', (e) => {
  if (e.target.id === 'tutorial-modal') $('tutorial-modal').classList.remove('active');
});

// Mute button
$('mute-btn').addEventListener('click', () => {
  initAudio();
  toggleMute();
});
updateMuteButton();

$('start-btn').addEventListener('click', () => {
  initAudio();
  init();
  startShift();
});

$('next-btn').addEventListener('click', () => {
  game.shift++;
  if (game.shift >= CONFIG.shifts.length) {
    gameOver();
  } else {
    showUpgradeScreen();
  }
});

$('skip-upgrades').addEventListener('click', () => {
  startShift();
});

$('retry-btn').addEventListener('click', () => {
  showScreen('title-screen');
});

// Keyboard
document.addEventListener('keydown', e => {
  if (!game.running) return;
  const keys = ['q','w','e','r','t','y','u','i','o','p'];
  const idx = keys.indexOf(e.key.toLowerCase());
  if (idx >= 0 && idx < game.stalls.length) clickStall(idx);
  if (e.key === '1') $('pow-speed').click();
  if (e.key === '2') $('pow-slow').click();
  if (e.key === '3') $('pow-auto').click();

  // Space bar to click active task rapidly
  if (e.key === ' ' && game.activeTask >= 0) {
    e.preventDefault();
    const btn = $('task-buttons').querySelector('.task-btn.active');
    if (btn) btn.click();
  }
});
</script>
</body>
</html>
